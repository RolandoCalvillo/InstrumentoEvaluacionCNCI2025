<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNCI - Sistema de Evaluación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cnci-blue': '#2a6aff',
                        'cnci-orange': '#ff8500',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-cnci-blue to-blue-600 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 transform transition-all duration-300 hover:scale-105">
        <div class="text-center mb-8">
            <img src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo CNCI" class="mx-auto h-20 w-auto mb-4" onerror="this.src=''; this.alt='Logo CNCI'; this.innerHTML='<div class=\'bg-cnci-blue text-white rounded-full w-20 h-20 flex items-center justify-center text-2xl font-bold mx-auto\'>CNCI</div>';">
            <h1 id="loginTitle" class="text-2xl font-bold text-gray-800 mb-2">Sistema de Evaluación</h1>
            <p id="loginSubtitle" class="text-gray-600">Ingresa tus credenciales para continuar</p>
        </div>



        <form id="loginForm" class="space-y-6">
            <div class="space-y-2">
                <label for="usuario" class="block text-sm font-semibold text-gray-700">Usuario</label>
                <input 
                    type="text" 
                    id="usuario" 
                    name="usuario" 
                    required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-cnci-blue focus:outline-none transition-colors duration-200 text-gray-800"
                    placeholder="Ingresa tu usuario"
                >
            </div>

            <div class="space-y-2">
                <label for="password" class="block text-sm font-semibold text-gray-700">Contraseña</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-cnci-blue focus:outline-none transition-colors duration-200 text-gray-800"
                    placeholder="Ingresa tu contraseña"
                >
            </div>

            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm">
                <span id="errorText"></span>
            </div>

            <div id="loadingSpinner" class="hidden text-center">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-cnci-blue"></div>
                <span class="ml-2 text-gray-600">Validando credenciales...</span>
            </div>

            <button 
                type="submit" 
                id="loginButton"
                class="w-full bg-cnci-orange hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-300"
            >
                Consultar mi Evaluación
            </button>
        </form>



        <div class="mt-4 text-center text-sm text-gray-500">
            <p>© 2024 CNCI - Sistema de Evaluación</p>
        </div>
    </div>

    <div id="superAdminView" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 space-y-2 sm:space-y-0">
                    <div class="flex items-center space-x-4">
                        <img src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo CNCI" class="h-10 w-auto" onerror="this.style.display='none';">
                        <div>
                            <h1 class="text-xl font-bold text-cnci-blue">Panel Super Administrador</h1>
                            <p class="text-sm text-gray-600">Gestión completa del sistema</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div id="adminFirebaseStatus" class="flex items-center text-sm">
                            <div id="adminStatusIcon" class="w-2 h-2 rounded-full mr-2"></div>
                            <span id="adminStatusText">Firebase</span>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex flex-wrap space-x-2 sm:space-x-8 px-6" aria-label="Tabs">
                        <button onclick="switchAdminTab('dashboard')" id="admin-tab-dashboard" class="admin-tab-button active border-b-2 border-cnci-blue text-cnci-blue py-4 px-1 text-sm font-medium">
                            Dashboard
                        </button>
                        <button onclick="switchAdminTab('users')" id="admin-tab-users" class="admin-tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                            Gestión de Usuarios
                        </button>
                        <button onclick="switchAdminTab('modules')" id="admin-tab-modules" class="admin-tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                            Gestión de Módulos
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <div id="admin-content-dashboard" class="admin-tab-content">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Total Supervisores</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="totalSupervisors">0</p>
                                    </div>
                                </div>
                            </div>
            
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Total Asesores</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="totalAsesores">0</p>
                                    </div>
                                </div>
                            </div>
            
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Módulos Activos</p>
                                        <p class="text-2xl font-semibold text-gray-900">0</p>
                                    </div>
                                </div>
                            </div>
            
                            <div class="bg-white rounded-lg shadow-sm p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Evaluaciones</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="totalEvaluations">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
            
                        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Sincronización Firebase</h3>
                                    <p class="text-sm text-gray-600">Gestiona la sincronización de datos con la base de datos</p>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="initializeSampleData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        🔄 Inicializar Datos
                                    </button>
                                    <button onclick="syncWithFirebase()" class="bg-cnci-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        ☁️ Sincronizar Ahora
                                    </button>
                                    <button onclick="exportAllData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        📊 Exportar JSON
                                    </button>
                                    <button onclick="exportAllDataCSV()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        📄 Exportar CSV
                                    </button>
                                    <label for="importCSVFile" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer">
                                        📁 Importar CSV
                                    </label>
                                    <input type="file" id="importCSVFile" accept=".csv" class="hidden" onchange="importCSVData(event)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="admin-content-users" class="admin-tab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm">
                            <div class="p-6">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-2 sm:space-y-0">
                                    <h2 class="text-xl font-semibold text-gray-800">Gestión de Usuarios</h2>
                                    <button onclick="openCreateUserModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        ➕ Crear Usuario
                                    </button>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                                    <select id="roleFilter" onchange="filterUsers()" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:border-cnci-blue focus:outline-none">
                                        <option value="">Todos los roles</option>
                                        <option value="supervisor">Supervisores</option>
                                        <option value="asesor">Asesores</option>
                                    </select>
                                    <input type="text" id="searchUsers" onkeyup="filterUsers()" placeholder="Buscar usuarios..." class="border border-gray-300 rounded-md px-3 py-2 text-sm flex-1 min-w-0 focus:border-cnci-blue focus:outline-none">
                                </div>
            
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="admin-content-modules" class="admin-tab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm">
                            <div class="p-6">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-2 sm:space-y-0">
                                    <h2 class="text-xl font-semibold text-gray-800">Gestión de Módulos</h2>
                                    <button onclick="openModuleModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                        ➕ Crear Módulo
                                    </button>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modulesTableBody" class="bg-white divide-y divide-gray-200">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="supervisorView" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 space-y-2 sm:space-y-0">
                    <div class="flex items-center space-x-4">
                        <img src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo CNCI" class="h-10 w-auto" onerror="this.style.display='none';">
                        <div>
                            <h1 class="text-xl font-bold text-cnci-blue">Panel Supervisor</h1>
                            <p class="text-sm text-gray-600" id="supervisorName">Supervisor</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div id="supervisorFirebaseStatus" class="flex items-center text-sm">
                            <div id="supervisorStatusIcon" class="w-2 h-2 rounded-full mr-2"></div>
                            <span id="supervisorStatusText">Firebase</span>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="supervisorModuleSelector" class="text-sm font-medium text-gray-700">Módulo:</label>
                    <select id="supervisorModuleSelector" onchange="loadModuleData()" class="border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                        </select>
                    <div class="text-sm text-gray-500" id="moduleDescription">
                        Selecciona un módulo para ver su descripción
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Edición de Títulos</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Título Principal</label>
                            <input type="text" id="mainTitle" value="Sistema de Evaluación" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subtítulo</label>
                            <input type="text" id="subtitle" value="Ingresa tus credenciales para continuar" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                        </div>
                        <button onclick="updateLoginTitles()" class="w-full bg-cnci-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Actualizar Títulos
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Gestión de Categorías</h3>
                    <div class="space-y-3">
                        <button onclick="openCategoryManagerModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            ⚙️ Configurar Categorías
                        </button>
                        <button onclick="resetModuleCategories()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            🔄 Restaurar por Defecto
                        </button>
                        <button onclick="previewCategoryChanges()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            👁️ Vista Previa
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Acciones Rápidas</h3>
                    <div class="space-y-3">
                        <button onclick="openAddAsesorModal()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            ➕ Añadir Asesor
                        </button>
                        <button onclick="openClearTableModal()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            🗑️ Vaciar Tabla
                        </button>
                        <button onclick="exportAsesoresData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            📊 Exportar JSON
                        </button>
                        <button onclick="exportAsesoresCSV()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            📄 Exportar CSV
                        </button>
                        <label for="importAsesoresCSV" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer text-center block">
                            📁 Importar CSV
                        </label>
                        <input type="file" id="importAsesoresCSV" accept=".csv" class="hidden" onchange="importAsesoresCSV(event)">
                        <button onclick="syncWithFirebase()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            🔄 Sincronizar Firebase
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm">
                <div class="p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
                        <h2 class="text-xl font-semibold text-gray-800">Gestión de Asesores</h2>
                        <div class="text-sm text-gray-500" id="currentModuleInfo">
                            Módulo: No seleccionado
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contraseña</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Promedio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="asesoresTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="asesorView" class="hidden min-h-screen bg-gray-50">
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 space-y-2 sm:space-y-0">
                    <div class="flex items-center space-x-4">
                        <img src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo CNCI" class="h-10 w-auto" onerror="this.style.display='none';">
                        <div>
                            <h1 class="text-xl font-bold text-cnci-blue">Dashboard Asesor</h1>
                            <select id="moduleSelector" onchange="loadAsesorModuleData()" class="mt-1 text-sm border border-gray-300 rounded-md px-3 py-1 focus:border-cnci-blue focus:outline-none">
                                </select>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div id="supervisorFirebaseStatus" class="flex items-center text-sm">
                            <div id="supervisorStatusIcon" class="w-2 h-2 rounded-full mr-2"></div>
                            <span id="supervisorStatusText">Firebase</span>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <h2 class="text-lg font-semibold text-gray-800">¡Bienvenido(a), <span id="asesorName">Asesor</span>!</h2>
                <p class="text-gray-600 text-sm">Aquí puedes consultar tu evaluación y seguimiento de desempeño.</p>
            </div>

            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex flex-wrap space-x-2 sm:space-x-8 px-6" aria-label="Tabs">
                        <button onclick="switchTab('resumen')" id="tab-resumen" class="tab-button active border-b-2 border-cnci-blue text-cnci-blue py-4 px-1 text-sm font-medium">
                            Resumen General
                        </button>
                        <button onclick="switchTab('insignias')" id="tab-insignias" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                            Insignias
                        </button>
                        <button onclick="switchTab('plan')" id="tab-plan" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">
                            Plan de Trabajo
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <div id="content-resumen" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-green-800 mb-4">Calificación General</h3>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-green-700">Promedio</span>
                                    <span class="text-lg font-bold text-green-800" id="generalScore">0.0</span>
                                </div>
                                <div class="w-full bg-green-200 rounded-full h-3">
                                    <div id="generalProgressBar" class="bg-green-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-blue-800 mb-4">Meta de Llamadas</h3>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-blue-700">Completado</span>
                                    <span class="text-lg font-bold text-blue-800">85%</span>
                                </div>
                                <div class="w-full bg-blue-200 rounded-full h-3">
                                    <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-800 mb-6">Categorías y Criterios de Evaluación</h3>
                        <div id="categoriesContainer" class="space-y-6">
                            </div>
                    </div>

                    <div id="content-insignias" class="tab-content hidden">
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Insignias Obtenidas</h3>
                                <div id="earnedBadges" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div id="content-plan" class="tab-content hidden">
                        <div class="space-y-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-blue-800 mb-4">Instrucciones para el Plan de Trabajo</h3>
                                <p class="text-blue-700 text-sm leading-relaxed mb-4">
                                    A partir de los resultados de tu evaluación, identifica de 3 a 4 áreas de oportunidad y describe acciones concretas que puedas implementar para mejorarlas.
                                </p>
                            </div>
                            
                            <div class="text-center">
                                <button onclick="window.open('https://docs.google.com/document/create', '_blank')" class="bg-cnci-orange hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 transform hover:scale-105">
                                    Crear mi Plan de Trabajo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="createUserModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Crear Nuevo Usuario</h3>
                <form id="createUserForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="newUserName" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Usuario</label>
                        <input type="text" id="newUserUsername" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contraseña</label>
                        <input type="password" id="newUserPassword" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Rol</label>
                        <select id="newUserRole" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                            <option value="">Seleccionar rol</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="asesor">Asesor</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeCreateUserModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">Crear Usuario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Editar Usuario</h3>
                <form id="editUserForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="editUserName" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Usuario</label>
                        <input type="text" id="editUserUsername" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Rol</label>
                        <select id="editUserRole" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                            <option value="supervisor">Supervisor</option>
                            <option value="asesor">Asesor</option>
                        </select>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="resetPassword" class="mr-2">
                            <span class="text-sm text-yellow-800">Restablecer contraseña</span>
                        </label>
                        <input type="password" id="newPassword" class="mt-2 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm hidden" placeholder="Nueva contraseña">
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeEditUserModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                        <button type="submit" class="bg-cnci-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="addAsesorModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Añadir Nuevo Asesor</h3>
                <form id="addAsesorForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="newAsesorName" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Usuario</label>
                        <input type="text" id="newAsesorUsername" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contraseña</label>
                        <input type="password" id="newAsesorPassword" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddAsesorModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">Añadir Asesor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="clearTableModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Confirmar Eliminación</h3>
                <p class="text-sm text-gray-500 mb-6">¿Estás seguro de que deseas eliminar todos los datos de los asesores? Esta acción no se puede deshacer.</p>
                <div class="flex justify-center space-x-3">
                    <button onclick="closeClearTableModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                    <button onclick="clearAllAsesores()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">Eliminar Todo</button>
                </div>
            </div>
        </div>
    </div>

    <div id="categoryManagerModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-5 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Configuración de Categorías y Criterios</h3>
                        <p class="text-sm text-gray-600 mt-1">Módulo: <span id="categoryModuleName"></span></p>
                    </div>
                    <button onclick="closeCategoryManagerModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-6">
                    <button onclick="addNewCategory()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        ➕ Añadir Nueva Categoría
                    </button>
                </div>

                <div id="categoriesEditor" class="space-y-6 max-h-96 overflow-y-auto">
                    </div>

                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                    <button onclick="closeCategoryManagerModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                    <button onclick="saveCategoryConfiguration()" class="bg-cnci-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">Guardar Configuración</button>
                </div>
            </div>
        </div>
    </div>

    <div id="categoryPreviewModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-medium text-gray-900">Vista Previa de Categorías</h3>
                    <button onclick="closeCategoryPreviewModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="categoryPreviewContent" class="space-y-4">
                    </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeCategoryPreviewModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="asesorDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-medium text-gray-900">Detalles del Asesor</h3>
                    <button onclick="closeAsesorDetailsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="asesorDetailsContent" class="space-y-6">
                    </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeAsesorDetailsModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                    <button onclick="saveAsesorDetails()" class="bg-cnci-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <div id="manageModulesModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900" id="moduleModalTitle">Crear Módulo</h3>
                    <button onclick="closeModuleModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="moduleForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ID del Módulo</label>
                        <input type="text" id="moduleId" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nombre del Módulo</label>
                        <input type="text" id="moduleName" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Descripción</label>
                        <textarea id="moduleDescriptionModal" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Estado</label>
                        <select id="moduleStatus" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                            <option value="active">Activo</option>
                            <option value="paused">En Pausa</option>
                            <option value="closed">Cerrado</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModuleModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg transition-colors">Cancelar</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">Guardar Módulo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        /**
         * CNCI Evaluation System - Version 5.0 with Firebase Integration
         * * Features:
         * - Production Firebase configuration
         * - Structured data synchronization
         * - Sample data initialization
         * - Real-time connection monitoring
         * - Offline persistence support
         * - Comprehensive error handling
         */

        // Firebase Configuration - Production Ready
        const firebaseConfig = {
            apiKey: "AIzaSyBMwQp-SobGp0GUDY6tt900lI7aPnSx1Cs",
            authDomain: "instrumentoevaluacioncnci2025.firebaseapp.com",
            projectId: "instrumentoevaluacioncnci2025",
            storageBucket: "instrumentoevaluacioncnci2025.firebasestorage.app",
            messagingSenderId: "143665328342",
            appId: "1:143665328342:web:e2505ddf46661541ea5977"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence().catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
            } else if (err.code == 'unimplemented') {
                console.warn('The current browser does not support all of the features required to enable persistence');
            }
        });

        // Static Module Configuration (M1-M12)
        const MODULES = {
            'M1': {
                id: 'M1',
                name: 'Módulo 1',
                title: 'Módulo 1',
                description: 'Principios básicos de servicio al cliente y comunicación efectiva',
                status: 'active',
                categories: [
                    {
                        id: 'communication',
                        name: 'Comunicación',
                        color: 'blue',
                        criteria: [
                            { name: 'Claridad en la comunicación', weight: 0.3 },
                            { name: 'Escucha activa', weight: 0.3 },
                            { name: 'Empatía', weight: 0.4 }
                        ]
                    },
                    {
                        id: 'service_quality',
                        name: 'Calidad de Servicio',
                        color: 'green',
                        criteria: [
                            { name: 'Tiempo de respuesta', weight: 0.4 },
                            { name: 'Resolución efectiva', weight: 0.6 }
                        ]
                    }
                ]
            },
            'M2': {
                id: 'M2',
                name: 'Módulo 2',
                title: 'Módulo 2',
                description: 'Estrategias y técnicas para el proceso de ventas efectivo',
                status: 'active',
                categories: [
                    {
                        id: 'sales_technique',
                        name: 'Técnica de Ventas',
                        color: 'purple',
                        criteria: [
                            { name: 'Identificación de necesidades', weight: 0.3 },
                            { name: 'Presentación del producto', weight: 0.3 },
                            { name: 'Manejo de objeciones', weight: 0.4 }
                        ]
                    },
                    {
                        id: 'closing',
                        name: 'Cierre de Ventas',
                        color: 'orange',
                        criteria: [
                            { name: 'Técnicas de cierre', weight: 0.5 },
                            { name: 'Seguimiento post-venta', weight: 0.5 }
                        ]
                    }
                ]
            },
            'M3': {
                id: 'M3',
                name: 'Módulo 3',
                title: 'Módulo 3',
                description: 'Construcción y mantenimiento de relaciones con clientes',
                status: 'active',
                categories: [
                    {
                        id: 'relationship_building',
                        name: 'Construcción de Relaciones',
                        color: 'green',
                        criteria: [
                            { name: 'Rapport con el cliente', weight: 0.4 },
                            { name: 'Confianza y credibilidad', weight: 0.6 }
                        ]
                    }
                ]
            },
            'M4': {
                id: 'M4',
                name: 'Módulo 4',
                title: 'Módulo 4',
                description: 'Manejo efectivo de situaciones difíciles y quejas',
                status: 'active',
                categories: [
                    {
                        id: 'conflict_resolution',
                        name: 'Resolución de Conflictos',
                        color: 'red',
                        criteria: [
                            { name: 'Manejo de quejas', weight: 0.4 },
                            { name: 'Negociación', weight: 0.3 },
                            { name: 'Soluciones creativas', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M5': {
                id: 'M5',
                name: 'Módulo 5',
                title: 'Módulo 5',
                description: 'Dominio completo de productos y servicios ofrecidos',
                status: 'active',
                categories: [
                    {
                        id: 'product_knowledge',
                        name: 'Conocimiento del Producto',
                        color: 'blue',
                        criteria: [
                            { name: 'Características técnicas', weight: 0.4 },
                            { name: 'Beneficios y ventajas', weight: 0.3 },
                            { name: 'Comparación competitiva', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M6': {
                id: 'M6',
                name: 'Módulo 6',
                title: 'Módulo 6',
                description: 'Optimización del tiempo y productividad en el trabajo',
                status: 'active',
                categories: [
                    {
                        id: 'time_management',
                        name: 'Gestión del Tiempo',
                        color: 'purple',
                        criteria: [
                            { name: 'Planificación diaria', weight: 0.3 },
                            { name: 'Priorización de tareas', weight: 0.4 },
                            { name: 'Cumplimiento de horarios', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M7': {
                id: 'M7',
                name: 'Módulo 7',
                title: 'Módulo 7',
                description: 'Colaboración efectiva y sinergia grupal',
                status: 'active',
                categories: [
                    {
                        id: 'teamwork',
                        name: 'Trabajo en Equipo',
                        color: 'green',
                        criteria: [
                            { name: 'Colaboración', weight: 0.4 },
                            { name: 'Comunicación interna', weight: 0.3 },
                            { name: 'Apoyo a compañeros', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M8': {
                id: 'M8',
                name: 'Módulo 8',
                title: 'Módulo 8',
                description: 'Desarrollo de habilidades de liderazgo y motivación',
                status: 'active',
                categories: [
                    {
                        id: 'leadership',
                        name: 'Liderazgo',
                        color: 'orange',
                        criteria: [
                            { name: 'Toma de decisiones', weight: 0.4 },
                            { name: 'Motivación del equipo', weight: 0.3 },
                            { name: 'Delegación efectiva', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M9': {
                id: 'M9',
                name: 'Módulo 9',
                title: 'Módulo 9',
                description: 'Desarrollo del pensamiento creativo y soluciones innovadoras',
                status: 'active',
                categories: [
                    {
                        id: 'innovation',
                        name: 'Innovación',
                        color: 'purple',
                        criteria: [
                            { name: 'Pensamiento creativo', weight: 0.4 },
                            { name: 'Propuestas de mejora', weight: 0.3 },
                            { name: 'Adaptabilidad', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M10': {
                id: 'M10',
                name: 'Módulo 10',
                title: 'Módulo 10',
                description: 'Principios éticos y responsabilidad profesional',
                status: 'active',
                categories: [
                    {
                        id: 'ethics',
                        name: 'Ética Profesional',
                        color: 'blue',
                        criteria: [
                            { name: 'Integridad', weight: 0.4 },
                            { name: 'Confidencialidad', weight: 0.3 },
                            { name: 'Responsabilidad', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M11': {
                id: 'M11',
                name: 'Módulo 11',
                title: 'Módulo 11',
                description: 'Dominio de herramientas tecnológicas y sistemas',
                status: 'active',
                categories: [
                    {
                        id: 'technology',
                        name: 'Competencia Tecnológica',
                        color: 'green',
                        criteria: [
                            { name: 'Manejo de sistemas', weight: 0.4 },
                            { name: 'Herramientas digitales', weight: 0.3 },
                            { name: 'Adaptación tecnológica', weight: 0.3 }
                        ]
                    }
                ]
            },
            'M12': {
                id: 'M12',
                name: 'Módulo 12',
                title: 'Módulo 12',
                description: 'Evaluación comprehensiva de todas las competencias',
                status: 'active',
                categories: [
                    {
                        id: 'comprehensive',
                        name: 'Evaluación Integral',
                        color: 'red',
                        criteria: [
                            { name: 'Desempeño general', weight: 0.5 },
                            { name: 'Mejora continua', weight: 0.5 }
                        ]
                    }
                ]
            }
        };

        // Global State Management
        let currentUser = null;
        let currentSupervisor = null;
        let currentModule = 'M1';
        let editingUserId = null;
        let editingAsesorId = null;
        let isFirebaseConnected = false;
        let firebaseRetryCount = 0;
        const MAX_RETRY_ATTEMPTS = 3;
        let customModuleCategories = {}; // Store custom categories per supervisor per module
        let tempCategoryConfig = null; // Temporary storage for category editing

        // Sample Data Structure - Will be synced to Firebase
        const sampleData = {
            // System configuration
            config: {
                loginTitle: "Sistema de Evaluación CNCI",
                loginSubtitle: "Ingresa tus credenciales para continuar",
                version: "5.0",
                lastUpdate: new Date().toISOString(),
                modules: MODULES
            },
            
            // Users database (excluding admin for security)
            users: {
                // Sample supervisor
                'supervisor1': {
                    password: 'super123',
                    role: 'supervisor',
                    name: 'Juan Supervisor',
                    email: 'supervisor@cnci.com',
                    status: 'active',
                    createdAt: '2024-01-10',
                    lastLogin: null,
                    permissions: ['manage_asesores', 'edit_titles', 'export_data'],
                    asesores: {
                        'M1': [
                            {
                                id: 'asesor1_m1',
                                username: 'maria.garcia',
                                name: 'María García',
                                password: 'asesor123',
                                module: 'M1',
                                email: 'maria.garcia@cnci.com',
                                phone: '+52 55 1234 5678',
                                department: 'Atención al Cliente',
                                supervisor: 'supervisor1',
                                categories: [
                                    {
                                        id: 'communication',
                                        name: 'Comunicación',
                                        score: 8.5,
                                        color: 'blue',
                                        criteria: [
                                            { name: 'Claridad en la comunicación', score: 9.0, weight: 0.3 },
                                            { name: 'Escucha activa', score: 8.0, weight: 0.3 },
                                            { name: 'Empatía', score: 8.5, weight: 0.4 }
                                        ],
                                        supervisionComment: 'Excelente desempeño en comunicación. Demuestra gran claridad al explicar procedimientos.',
                                        qualityComment: 'Muy buena calidad en la interacción con clientes. Mantiene un tono profesional.',
                                        lastEvaluation: '2024-01-15',
                                        evaluator: 'supervisor1'
                                    },
                                    {
                                        id: 'service_quality',
                                        name: 'Calidad de Servicio',
                                        score: 7.8,
                                        color: 'green',
                                        criteria: [
                                            { name: 'Tiempo de respuesta', score: 8.5, weight: 0.4 },
                                            { name: 'Resolución efectiva', score: 7.2, weight: 0.6 }
                                        ],
                                        supervisionComment: 'Buen manejo de tiempos. Área de oportunidad en resolución compleja.',
                                        qualityComment: 'Calidad consistente en el servicio. Seguir trabajando en casos complejos.',
                                        lastEvaluation: '2024-01-15',
                                        evaluator: 'supervisor1'
                                    }
                                ],
                                badges: [
                                    { 
                                        emoji: '🏆', 
                                        title: 'Maestro(a) de Comunicación', 
                                        description: 'Reconocimiento por excelente comunicación con clientes.',
                                        dateEarned: '2024-01-20',
                                        criteria: 'Puntuación superior a 8.0 en comunicación'
                                    },
                                    { 
                                        emoji: '⭐', 
                                        title: 'Estrella del Mes', 
                                        description: 'Otorgada por superar las metas mensuales.',
                                        dateEarned: '2024-01-31',
                                        criteria: 'Cumplimiento del 100% de objetivos mensuales'
                                    }
                                ],
                                performance: {
                                    callsHandled: 245,
                                    averageCallTime: '4:32',
                                    customerSatisfaction: 4.6,
                                    goalsAchieved: 92,
                                    attendanceRate: 98
                                },
                                createdAt: '2024-01-10',
                                lastUpdate: '2024-01-20'
                            },
                            {
                                id: 'asesor2_m1',
                                username: 'carlos.lopez',
                                name: 'Carlos López',
                                password: 'carlos123',
                                module: 'M1',
                                email: 'carlos.lopez@cnci.com',
                                phone: '+52 55 9876 5432',
                                department: 'Atención al Cliente',
                                supervisor: 'supervisor1',
                                categories: [
                                    {
                                        id: 'communication',
                                        name: 'Comunicación',
                                        score: 7.2,
                                        color: 'blue',
                                        criteria: [
                                            { name: 'Claridad en la comunicación', score: 7.5, weight: 0.3 },
                                            { name: 'Escucha activa', score: 6.8, weight: 0.3 },
                                            { name: 'Empatía', score: 7.3, weight: 0.4 }
                                        ],
                                        supervisionComment: 'Buen desempeño general. Trabajar en escucha activa.',
                                        qualityComment: 'Calidad aceptable. Mejorar la paciencia con clientes difíciles.',
                                        lastEvaluation: '2024-01-15',
                                        evaluator: 'supervisor1'
                                    },
                                    {
                                        id: 'service_quality',
                                        name: 'Calidad de Servicio',
                                        score: 6.9,
                                        color: 'green',
                                        criteria: [
                                            { name: 'Tiempo de respuesta', score: 7.2, weight: 0.4 },
                                            { name: 'Resolución efectiva', score: 6.7, weight: 0.6 }
                                        ],
                                        supervisionComment: 'Tiempos adecuados. Mejorar efectividad en resolución.',
                                        qualityComment: 'Servicio estándar. Oportunidad de crecimiento en resolución.',
                                        lastEvaluation: '2024-01-15',
                                        evaluator: 'supervisor1'
                                    }
                                ],
                                badges: [
                                    { 
                                        emoji: '📈', 
                                        title: 'En Crecimiento', 
                                        description: 'Reconocimiento por mejora continua.',
                                        dateEarned: '2024-01-25',
                                        criteria: 'Mejora sostenida en evaluaciones'
                                    }
                                ],
                                performance: {
                                    callsHandled: 198,
                                    averageCallTime: '5:15',
                                    customerSatisfaction: 4.1,
                                    goalsAchieved: 78,
                                    attendanceRate: 95
                                },
                                createdAt: '2024-01-10',
                                lastUpdate: '2024-01-20'
                            }
                        ],
                        'M2': [
                            {
                                id: 'asesor3_m2',
                                username: 'ana.martinez',
                                name: 'Ana Martínez',
                                password: 'ana123',
                                module: 'M2',
                                email: 'ana.martinez@cnci.com',
                                phone: '+52 55 5555 1234',
                                department: 'Ventas',
                                supervisor: 'supervisor1',
                                categories: [
                                    {
                                        id: 'sales_technique',
                                        name: 'Técnica de Ventas',
                                        score: 9.1,
                                        color: 'purple',
                                        criteria: [
                                            { name: 'Identificación de necesidades', score: 9.2, weight: 0.3 },
                                            { name: 'Presentación del producto', score: 8.8, weight: 0.3 },
                                            { name: 'Manejo de objeciones', score: 9.3, weight: 0.4 }
                                        ],
                                        supervisionComment: 'Excelente técnica de ventas. Manejo excepcional de objeciones.',
                                        qualityComment: 'Calidad superior en presentaciones. Muy profesional.',
                                        lastEvaluation: '2024-01-18',
                                        evaluator: 'supervisor1'
                                    },
                                    {
                                        id: 'closing',
                                        name: 'Cierre de Ventas',
                                        score: 8.7,
                                        color: 'orange',
                                        criteria: [
                                            { name: 'Técnicas de cierre', score: 8.9, weight: 0.5 },
                                            { name: 'Seguimiento post-venta', score: 8.5, weight: 0.5 }
                                        ],
                                        supervisionComment: 'Muy buenas técnicas de cierre. Excelente seguimiento.',
                                        qualityComment: 'Cierre efectivo y seguimiento consistente.',
                                        lastEvaluation: '2024-01-18',
                                        evaluator: 'supervisor1'
                                    }
                                ],
                                badges: [
                                    { 
                                        emoji: '💎', 
                                        title: 'Vendedor Diamante', 
                                        description: 'Reconocimiento por excelencia en ventas.',
                                        dateEarned: '2024-01-22',
                                        criteria: 'Puntuación superior a 9.0 en técnicas de ventas'
                                    },
                                    { 
                                        emoji: '🎯', 
                                        title: 'Meta Alcanzada', 
                                        description: 'Cumplimiento del 120% de la meta mensual.',
                                        dateEarned: '2024-01-31',
                                        criteria: 'Superar meta mensual en 20%'
                                    }
                                ],
                                performance: {
                                    salesMade: 45,
                                    conversionRate: 68,
                                    averageTicket: 2850,
                                    goalsAchieved: 120,
                                    attendanceRate: 100
                                },
                                createdAt: '2024-01-12',
                                lastUpdate: '2024-01-22'
                            }
                        ]
                    }
                },
                
                // Sample standalone asesor
                'maria.garcia': {
                    password: 'asesor123',
                    role: 'asesor',
                    name: 'María García',
                    email: 'maria.garcia@cnci.com',
                    phone: '+52 55 1234 5678',
                    department: 'Atención al Cliente',
                    supervisor: 'supervisor1',
                    status: 'active',
                    createdAt: '2024-01-15',
                    lastLogin: null,
                    currentModule: 'M1',
                    moduleData: {
                        'M1': {
                            categories: [
                                {
                                    id: 'communication',
                                    name: 'Comunicación',
                                    score: 8.5,
                                    color: 'blue',
                                    criteria: [
                                        { name: 'Claridad en la comunicación', score: 9.0, weight: 0.3 },
                                        { name: 'Escucha activa', score: 8.0, weight: 0.3 },
                                        { name: 'Empatía', score: 8.5, weight: 0.4 }
                                    ],
                                    supervisionComment: 'Excelente desempeño en comunicación. Demuestra gran claridad al explicar procedimientos.',
                                    qualityComment: 'Muy buena calidad en la interacción con clientes. Mantiene un tono profesional.',
                                    lastEvaluation: '2024-01-15',
                                    evaluator: 'supervisor1'
                                },
                                {
                                    id: 'service_quality',
                                    name: 'Calidad de Servicio',
                                    score: 7.8,
                                    color: 'green',
                                    criteria: [
                                        { name: 'Tiempo de respuesta', score: 8.5, weight: 0.4 },
                                        { name: 'Resolución efectiva', score: 7.2, weight: 0.6 }
                                    ],
                                    supervisionComment: 'Buen manejo de tiempos. Área de oportunidad en resolución compleja.',
                                    qualityComment: 'Calidad consistente en el servicio. Seguir trabajando en casos complejos.',
                                    lastEvaluation: '2024-01-15',
                                    evaluator: 'supervisor1'
                                }
                            ],
                            badges: [
                                { 
                                    emoji: '🏆', 
                                    title: 'Maestro(a) de Comunicación', 
                                    description: 'Reconocimiento por excelente comunicación con clientes.',
                                    dateEarned: '2024-01-20',
                                    criteria: 'Puntuación superior a 8.0 en comunicación'
                                }
                            ],
                            performance: {
                                callsHandled: 245,
                                averageCallTime: '4:32',
                                customerSatisfaction: 4.6,
                                goalsAchieved: 92,
                                attendanceRate: 98
                            }
                        },
                        'M2': {
                            categories: [],
                            badges: [],
                            performance: {}
                        }
                    }
                },

                'carlos.lopez': {
                    password: 'carlos123',
                    role: 'asesor',
                    name: 'Carlos López',
                    email: 'carlos.lopez@cnci.com',
                    phone: '+52 55 9876 5432',
                    department: 'Atención al Cliente',
                    supervisor: 'supervisor1',
                    status: 'active',
                    createdAt: '2024-01-15',
                    lastLogin: null,
                    currentModule: 'M1',
                    moduleData: {
                        'M1': {
                            categories: [
                                {
                                    id: 'communication',
                                    name: 'Comunicación',
                                    score: 7.2,
                                    color: 'blue',
                                    criteria: [
                                        { name: 'Claridad en la comunicación', score: 7.5, weight: 0.3 },
                                        { name: 'Escucha activa', score: 6.8, weight: 0.3 },
                                        { name: 'Empatía', score: 7.3, weight: 0.4 }
                                    ],
                                    supervisionComment: 'Buen desempeño general. Trabajar en escucha activa.',
                                    qualityComment: 'Calidad aceptable. Mejorar la paciencia con clientes difíciles.',
                                    lastEvaluation: '2024-01-15',
                                    evaluator: 'supervisor1'
                                }
                            ],
                            badges: [
                                { 
                                    emoji: '📈', 
                                    title: 'En Crecimiento', 
                                    description: 'Reconocimiento por mejora continua.',
                                    dateEarned: '2024-01-25',
                                    criteria: 'Mejora sostenida en evaluaciones'
                                }
                            ],
                            performance: {
                                callsHandled: 198,
                                averageCallTime: '5:15',
                                customerSatisfaction: 4.1,
                                goalsAchieved: 78,
                                attendanceRate: 95
                            }
                        }
                    }
                },

                'ana.martinez': {
                    password: 'ana123',
                    role: 'asesor',
                    name: 'Ana Martínez',
                    email: 'ana.martinez@cnci.com',
                    phone: '+52 55 5555 1234',
                    department: 'Ventas',
                    supervisor: 'supervisor1',
                    status: 'active',
                    createdAt: '2024-01-15',
                    lastLogin: null,
                    currentModule: 'M2',
                    moduleData: {
                        'M2': {
                            categories: [
                                {
                                    id: 'sales_technique',
                                    name: 'Técnica de Ventas',
                                    score: 9.1,
                                    color: 'purple',
                                    criteria: [
                                        { name: 'Identificación de necesidades', score: 9.2, weight: 0.3 },
                                        { name: 'Presentación del producto', score: 8.8, weight: 0.3 },
                                        { name: 'Manejo de objeciones', score: 9.3, weight: 0.4 }
                                    ],
                                    supervisionComment: 'Excelente técnica de ventas. Manejo excepcional de objeciones.',
                                    qualityComment: 'Calidad superior en presentaciones. Muy profesional.',
                                    lastEvaluation: '2024-01-18',
                                    evaluator: 'supervisor1'
                                },
                                {
                                    id: 'closing',
                                    name: 'Cierre de Ventas',
                                    score: 8.7,
                                    color: 'orange',
                                    criteria: [
                                        { name: 'Técnicas de cierre', score: 8.9, weight: 0.5 },
                                        { name: 'Seguimiento post-venta', score: 8.5, weight: 0.5 }
                                    ],
                                    supervisionComment: 'Muy buenas técnicas de cierre. Excelente seguimiento.',
                                    qualityComment: 'Cierre efectivo y seguimiento consistente.',
                                    lastEvaluation: '2024-01-18',
                                    evaluator: 'supervisor1'
                                }
                            ],
                            badges: [
                                { 
                                    emoji: '💎', 
                                    title: 'Vendedor Diamante', 
                                    description: 'Reconocimiento por excelencia en ventas.',
                                    dateEarned: '2024-01-22',
                                    criteria: 'Puntuación superior a 9.0 en técnicas de ventas'
                                },
                                { 
                                    emoji: '🎯', 
                                    title: 'Meta Alcanzada', 
                                    description: 'Cumplimiento del 120% de la meta mensual.',
                                    dateEarned: '2024-01-31',
                                    criteria: 'Superar meta mensual en 20%'
                                }
                            ],
                            performance: {
                                salesMade: 45,
                                conversionRate: 68,
                                averageTicket: 2850,
                                goalsAchieved: 120,
                                attendanceRate: 100
                            },
                            createdAt: '2024-01-12',
                            lastUpdate: '2024-01-22'
                        }
                    }
                }
            }
        };

        // Local data storage (includes admin + sample data)
        const systemData = {
            config: sampleData.config,
            users: {
                // Super admin (local only for security)
                'admin': {
                    password: 'admin123',
                    role: 'super_admin',
                    name: 'Administrador Principal',
                    status: 'active',
                    createdAt: '2024-01-01',
                    permissions: ['all']
                },
                ...sampleData.users
            }
        };

        // DOM Elements Cache - Initialize after DOM is loaded
        let elements = {};
        let editingModuleId = null;

        /**
         * Firebase Integration Functions
         */
        
        // Initialize Firebase connection with retry logic
        async function initializeFirebase() {
            try {
                console.log('Initializing Firebase connection...');
                updateFirebaseStatus('connecting', 'Conectando a Firebase...');
                
                // Test Firebase connection with a simple read
                const testDoc = await db.collection('system_status').doc('connection_test').get();
                
                // If we get here, Firebase is connected
                isFirebaseConnected = true;
                firebaseRetryCount = 0;
                updateFirebaseStatus('connected', 'Conectado a Firebase');
                
                console.log('Firebase connected successfully');
                
                // Load existing data from Firebase
                await loadFromFirebase();
                
                // Update connection status in Firebase
                await updateConnectionStatus();
                
                return true;
                
            } catch (error) {
                console.warn('Firebase connection failed:', error);
                isFirebaseConnected = false;
                firebaseRetryCount++;
                
                if (firebaseRetryCount < MAX_RETRY_ATTEMPTS) {
                    updateFirebaseStatus('retrying', `Reintentando conexión (${firebaseRetryCount}/${MAX_RETRY_ATTEMPTS})...`);
                    setTimeout(() => initializeFirebase(), 2000 * firebaseRetryCount);
                } else {
                    updateFirebaseStatus('offline', 'Modo offline - Datos locales');
                }
                
                return false;
            }
        }

        // Update Firebase connection status in UI
        function updateFirebaseStatus(status, message) {
            const statusClasses = {
                connecting: { bg: 'bg-yellow-100 border-yellow-300 text-yellow-800', icon: 'bg-yellow-500' },
                connected: { bg: 'bg-green-100 border-green-300 text-green-800', icon: 'bg-green-500' },
                retrying: { bg: 'bg-orange-100 border-orange-300 text-orange-800', icon: 'bg-orange-500' },
                offline: { bg: 'bg-gray-100 border-gray-300 text-gray-800', icon: 'bg-gray-500' },
                error: { bg: 'bg-red-100 border-red-300 text-red-800', icon: 'bg-red-500' }
            };

            const statusClass = statusClasses[status] || statusClasses.offline;

            // Update Super Admin panel status
            if (elements.adminStatusIcon && elements.adminStatusText) {
                elements.adminStatusIcon.className = `w-2 h-2 rounded-full mr-2 ${statusClass.icon}`;
                elements.adminStatusText.textContent = status === 'connected' ? 'Conectado' : 'Desconectado';
            }

            // Update Supervisor panel status
            if (elements.supervisorStatusIcon && elements.supervisorStatusText) {
                elements.supervisorStatusIcon.className = `w-2 h-2 rounded-full mr-2 ${statusClass.icon}`;
                elements.supervisorStatusText.textContent = status === 'connected' ? 'Conectado' : 'Desconectado';
            }
        }

        // Update connection status in Firebase
        async function updateConnectionStatus() {
            if (!isFirebaseConnected) return;

            try {
                await db.collection('system_status').doc('connection').set({
                    lastConnection: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active',
                    version: systemData.config.version,
                    userAgent: navigator.userAgent
                });
            } catch (error) {
                console.error('Error updating connection status:', error);
            }
        }

        // Initialize sample data in Firebase
        async function initializeSampleData() {
            if (!isFirebaseConnected) {
                showError('Firebase no está conectado. No se pueden inicializar los datos.');
                return;
            }

            try {
                showLoading(true);
                console.log('Initializing sample data in Firebase...');

                // Create batch for efficient writes
                const batch = db.batch();

                // Initialize system configuration
                const configRef = db.collection('config').doc('system');
                batch.set(configRef, {
                    ...sampleData.config,
                    initializedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    initializedBy: 'admin'
                });

                // Initialize users (excluding admin)
                Object.entries(sampleData.users).forEach(([username, userData]) => {
                    const userRef = db.collection('users').doc(username);
                    batch.set(userRef, {
                        ...userData,
                        syncedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        syncVersion: 1
                    });
                });

                // Initialize modules configuration
                const modulesRef = db.collection('config').doc('modules');
                batch.set(modulesRef, {
                    modules: MODULES,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    version: '1.0'
                });

                // Initialize system statistics
                const statsRef = db.collection('system_status').doc('statistics');
                batch.set(statsRef, {
                    totalUsers: Object.keys(sampleData.users).length,
                    totalSupervisors: Object.values(sampleData.users).filter(u => u.role === 'supervisor').length,
                    totalAsesores: Object.values(sampleData.users).filter(u => u.role === 'asesor').length,
                    totalModules: Object.keys(MODULES).length,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Commit batch
                await batch.commit();

                console.log('Sample data initialized successfully');
                showSuccess('Datos de ejemplo inicializados correctamente en Firebase');
                
                // Refresh UI
                if (currentUser && currentUser.role === 'super_admin') {
                    updateSystemStats();
                    loadAllUsers();
                }

            } catch (error) {
                console.error('Error initializing sample data:', error);
                showError('Error al inicializar datos: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Sync data with Firebase
        async function syncWithFirebase() {
            if (!isFirebaseConnected) {
                showError('Firebase no está conectado. Usando datos locales.');
                return;
            }

            try {
                showLoading(true);
                console.log('Syncing data with Firebase...');
                
                // Create batch for efficient writes
                const batch = db.batch();
                let operationCount = 0;
                const MAX_BATCH_SIZE = 500;

                // Sync system config
                const configRef = db.collection('config').doc('system');
                batch.set(configRef, {
                    ...systemData.config,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp(),
                    syncedBy: currentUser ? currentUser.username : 'system'
                }, { merge: true });
                operationCount++;

                // Sync users (excluding admin for security)
                for (const [username, userData] of Object.entries(systemData.users)) {
                    if (username !== 'admin' && operationCount < MAX_BATCH_SIZE) {
                        const userRef = db.collection('users').doc(username);
                        batch.set(userRef, {
                            ...userData,
                            lastSync: firebase.firestore.FieldValue.serverTimestamp(),
                            syncVersion: (userData.syncVersion || 0) + 1
                        }, { merge: true });
                        operationCount++;
                    }
                }

                // Commit batch
                if (operationCount > 0) {
                    await batch.commit();
                    console.log(`Synced ${operationCount} documents to Firebase`);
                }

                // Update connection status
                await updateConnectionStatus();

                showSuccess(`Datos sincronizados correctamente (${operationCount} documentos)`);
                
            } catch (error) {
                console.error('Error syncing with Firebase:', error);
                showError('Error al sincronizar con Firebase: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Load data from Firebase
        async function loadFromFirebase() {
            if (!isFirebaseConnected) return;

            try {
                console.log('Loading data from Firebase...');

                // Load system configuration
                const configDoc = await db.collection('config').doc('system').get();
                if (configDoc.exists) {
                    const configData = configDoc.data();
                    // Merge with local config, preserving local admin settings
                    Object.assign(systemData.config, {
                        loginTitle: configData.loginTitle || systemData.config.loginTitle,
                        loginSubtitle: configData.loginSubtitle || systemData.config.loginSubtitle,
                        version: configData.version || systemData.config.version,
                        lastUpdate: configData.lastUpdate || systemData.config.lastUpdate
                    });
                }

                // Load users (excluding admin)
                const usersSnapshot = await db.collection('users').get();
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    // Only load if not admin (admin stays local for security)
                    if (doc.id !== 'admin') {
                        systemData.users[doc.id] = userData;
                    }
                });
                
                // Load module configuration from Firebase
                const modulesDoc = await db.collection('config').doc('modules').get();
                if (modulesDoc.exists) {
                    const modulesData = modulesDoc.data();
                    Object.assign(systemData.config.modules, modulesData.modules);
                }

                console.log(`Loaded ${usersSnapshot.size} users from Firebase`);
                
                // Update login screen with loaded config
                if (document.getElementById('loginTitle')) {
                    document.getElementById('loginTitle').textContent = systemData.config.loginTitle;
                    document.getElementById('loginSubtitle').textContent = systemData.config.loginSubtitle;
                }

            } catch (error) {
                console.error('Error loading from Firebase:', error);
                // Don't show error to user, just log it and continue with local data
            }
        }

        // Export all data
        async function exportAllData() {
            try {
                showLoading(true);

                // Prepare export data
                const exportData = {
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        version: systemData.config.version,
                        exportedBy: currentUser ? currentUser.username : 'system',
                        totalUsers: Object.keys(systemData.users).length - 1, // Exclude admin
                        firebaseConnected: isFirebaseConnected
                    },
                    config: systemData.config,
                    modules: MODULES,
                    users: Object.fromEntries(
                        Object.entries(systemData.users).filter(([username]) => username !== 'admin')
                    )
                };

                // Create and download JSON file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cnci_system_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showSuccess('Datos exportados correctamente');

            } catch (error) {
                console.error('Error exporting data:', error);
                showError('Error al exportar datos: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Export all data as CSV (Super Admin)
        async function exportAllDataCSV() {
            try {
                showLoading(true);

                // Prepare CSV data for users
                const csvData = [];
                const headers = [
                    'Usuario', 'Nombre', 'Rol', 'Email', 'Teléfono', 'Departamento', 
                    'Estado', 'Supervisor', 'Módulo Actual', 'Fecha Creación', 'Último Login'
                ];
                csvData.push(headers);

                // Add user data (excluding admin)
                Object.entries(systemData.users).forEach(([username, userData]) => {
                    if (username === 'admin') return;
                    
                    const row = [
                        username,
                        userData.name || '',
                        userData.role || '',
                        userData.email || '',
                        userData.phone || '',
                        userData.department || '',
                        userData.status || 'active',
                        userData.supervisor || '',
                        userData.currentModule || '',
                        userData.createdAt || '',
                        userData.lastLogin || ''
                    ];
                    csvData.push(row);
                });

                // Convert to CSV string
                const csvContent = csvData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                // Create and download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cnci_usuarios_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showSuccess('Datos CSV exportados correctamente');

            } catch (error) {
                console.error('Error exporting CSV:', error);
                showError('Error al exportar CSV: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Import CSV data (Super Admin)
        async function importCSVData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showLoading(true);

                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showError('El archivo CSV debe contener al menos una fila de encabezados y una fila de datos');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                const expectedHeaders = ['Usuario', 'Nombre', 'Rol', 'Email', 'Teléfono', 'Departamento', 'Estado', 'Supervisor', 'Módulo Actual'];
                
                // Validate headers
                const hasRequiredHeaders = expectedHeaders.slice(0, 3).every(header => 
                    headers.some(h => h.toLowerCase().includes(header.toLowerCase()))
                );

                if (!hasRequiredHeaders) {
                    showError('El archivo CSV debe contener al menos las columnas: Usuario, Nombre, Rol');
                    return;
                }

                let importedCount = 0;
                let updatedCount = 0;
                let errorCount = 0;

                // Process data rows
                for (let i = 1; i < lines.length; i++) {
                    try {
                        const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                        
                        if (values.length < 3 || !values[0] || !values[1] || !values[2]) {
                            errorCount++;
                            continue;
                        }

                        const username = values[0];
                        const name = values[1];
                        const role = values[2].toLowerCase();

                        // Skip admin user
                        if (username === 'admin') continue;

                        // Validate role
                        if (!['supervisor', 'asesor'].includes(role)) {
                            errorCount++;
                            continue;
                        }

                        const userData = {
                            name: name,
                            role: role,
                            email: values[3] || `${username}@cnci.com`,
                            phone: values[4] || '',
                            department: values[5] || 'General',
                            status: values[6] || 'active',
                            supervisor: values[7] || null,
                            currentModule: values[8] || 'M1',
                            password: systemData.users[username]?.password || 'temp123',
                            createdAt: systemData.users[username]?.createdAt || new Date().toISOString().split('T')[0],
                            lastLogin: systemData.users[username]?.lastLogin || null,
                            syncVersion: (systemData.users[username]?.syncVersion || 0) + 1
                        };

                        // Add role-specific data
                        if (role === 'supervisor') {
                            userData.asesores = systemData.users[username]?.asesores || {};
                            userData.permissions = ['manage_asesores', 'edit_titles', 'export_data'];
                        } else if (role === 'asesor') {
                            userData.moduleData = systemData.users[username]?.moduleData || {};
                            // Initialize module data if empty
                            Object.keys(MODULES).forEach(moduleId => {
                                if (!userData.moduleData[moduleId]) {
                                    userData.moduleData[moduleId] = {
                                        categories: [],
                                        badges: [],
                                        performance: {}
                                    };
                                }
                            });
                        }

                        // Update or create user
                        if (systemData.users[username]) {
                            // Update existing user
                            Object.assign(systemData.users[username], userData);
                            updatedCount++;
                        } else {
                            // Create new user
                            systemData.users[username] = userData;
                            importedCount++;
                        }

                        // Update Firebase if connected
                        if (isFirebaseConnected) {
                            await db.collection('users').doc(username).set(userData, { merge: true });
                        }

                    } catch (rowError) {
                        console.error(`Error processing row ${i}:`, rowError);
                        errorCount++;
                    }
                }

                // Clear file input
                event.target.value = '';

                // Refresh UI
                if (currentUser && currentUser.role === 'super_admin') {
                    loadAllUsers();
                    updateSystemStats();
                }

                // Show results
                const message = `Importación completada: ${importedCount} nuevos usuarios, ${updatedCount} actualizados`;
                if (errorCount > 0) {
                    showError(`${message}. ${errorCount} errores encontrados.`);
                } else {
                    showSuccess(message);
                }

            } catch (error) {
                console.error('Error importing CSV:', error);
                showError('Error al importar CSV: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        /**
         * Utility Functions
         */
        
        // Show error message with auto-hide
        function showError(message) {
            elements.errorText.textContent = message;
            elements.errorMessage.classList.remove('hidden');
            setTimeout(() => {
                elements.errorMessage.classList.add('hidden');
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg text-sm z-50 transform transition-all duration-300';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => successDiv.remove(), 300);
            }, 3000);
        }

        // Show/hide loading state
        function showLoading(show) {
            if (show) {
                elements.loadingSpinner.classList.remove('hidden');
                if (elements.loginButton) {
                    elements.loginButton.disabled = true;
                    elements.loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                elements.loadingSpinner.classList.add('hidden');
                if (elements.loginButton) {
                    elements.loginButton.disabled = false;
                    elements.loginButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Hide all views
        function hideAllViews() {
            console.log('Hiding all views...');
            
            // Hide login view (the main container)
            const loginContainer = document.querySelector('body > div:first-child');
            if (loginContainer) {
                loginContainer.classList.add('hidden');
                console.log('Login view hidden');
            }
            
            // Hide other views
            if (elements.superAdminView) {
                elements.superAdminView.classList.add('hidden');
                console.log('Super admin view hidden');
            }
            if (elements.supervisorView) {
                elements.supervisorView.classList.add('hidden');
                console.log('Supervisor view hidden');
            }
            if (elements.asesorView) {
                elements.asesorView.classList.add('hidden');
                console.log('Asesor view hidden');
            }
        }

        // Calculate general score from categories
        function calculateGeneralScore(categories) {
            if (!categories || categories.length === 0) return 0;
            const sum = categories.reduce((acc, cat) => acc + cat.score, 0);
            return Math.round((sum / categories.length) * 10) / 10;
        }

        // Generate unique ID
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        /**
         * Module Management Functions
         */
        
        // Initialize module selectors
        function initializeModuleSelectors() {
            const supervisorSelector = document.getElementById('supervisorModuleSelector');
            const asesorSelector = document.getElementById('moduleSelector');
            
            // Clear existing options
            if (supervisorSelector) {
                supervisorSelector.innerHTML = '';
                Object.values(systemData.config.modules).forEach(module => {
                    const option = document.createElement('option');
                    option.value = module.id;
                    option.textContent = module.name;
                    supervisorSelector.appendChild(option);
                });
                supervisorSelector.value = currentModule;
            }
            
            if (asesorSelector) {
                asesorSelector.innerHTML = '';
                Object.values(systemData.config.modules).forEach(module => {
                    const option = document.createElement('option');
                    option.value = module.id;
                    option.textContent = module.name;
                    asesorSelector.appendChild(option);
                });
                asesorSelector.value = currentModule;
            }
            
            updateModuleDescription();
        }

        // Update module description
        function updateModuleDescription() {
            const module = systemData.config.modules[currentModule];
            const descElement = document.getElementById('moduleDescription');
            const currentModuleInfo = document.getElementById('currentModuleInfo');
            
            if (module && descElement) {
                descElement.textContent = module.description;
            }
            
            if (module && currentModuleInfo) {
                currentModuleInfo.textContent = `Módulo: ${module.name}`;
            }
        }

        // Load module data for supervisor
        function loadModuleData() {
            const selector = document.getElementById('supervisorModuleSelector');
            currentModule = selector.value;
            updateModuleDescription();
            loadAsesoresTable();
        }

        // Load module data for asesor
        function loadAsesorModuleData() {
            const selector = document.getElementById('moduleSelector');
            currentModule = selector.value;
            
            // Reload asesor data for the selected module
            if (currentUser && currentUser.moduleData && currentUser.moduleData[currentModule]) {
                const moduleData = currentUser.moduleData[currentModule];
                loadCategories(moduleData.categories);
                loadBadges(moduleData.badges);
                
                // Update general score
                const generalScore = calculateGeneralScore(moduleData.categories);
                document.getElementById('generalScore').textContent = generalScore.toFixed(1);
                
                // Update progress bar
                const progressBar = document.getElementById('generalProgressBar');
                progressBar.style.width = `${(generalScore / 10) * 100}%`;
            }
        }
        
        /**
         * Authentication Functions
         */
        
        // Authenticate user
        function authenticateUser(username, password) {
            console.log('🔍 Starting authentication for:', username);
            
            // Ensure systemData is properly initialized
            if (!systemData || !systemData.users) {
                console.error('❌ SystemData not initialized properly');
                console.error('SystemData:', systemData);
                throw new Error('Sistema no inicializado correctamente');
            }
            
            console.log('📋 Available users:', Object.keys(systemData.users));
            console.log('📋 SystemData structure:', {
                hasConfig: !!systemData.config,
                hasUsers: !!systemData.users,
                userCount: Object.keys(systemData.users).length
            });
            
            const user = systemData.users[username];
            console.log('👤 User lookup result:', {
                username: username,
                userExists: !!user,
                userData: user ? {
                    role: user.role,
                    name: user.name,
                    hasPassword: !!user.password,
                    status: user.status
                } : null
            });
            
            if (!user) {
                console.log('❌ User not found in systemData');
                console.log('🔍 Exact available users:', Object.keys(systemData.users));
                console.log('🔍 Searching for similar usernames...');
                
                const similarUsers = Object.keys(systemData.users).filter(u => 
                    u.toLowerCase().includes(username.toLowerCase()) || 
                    username.toLowerCase().includes(u.toLowerCase())
                );
                
                if (similarUsers.length > 0) {
                    console.log('🔍 Similar usernames found:', similarUsers);
                }
                
                throw new Error(`Usuario "${username}" no encontrado`);
            }
            
            console.log('🔐 User data details:', {
                role: user.role,
                status: user.status,
                hasPassword: !!user.password,
                passwordValue: user.password,
                name: user.name
            });
            
            console.log('🔑 Password comparison:', {
                provided: password,
                providedLength: password.length,
                stored: user.password,
                storedLength: user.password ? user.password.length : 0,
                match: user.password === password,
                providedType: typeof password,
                storedType: typeof user.password
            });
            
            // Check password
            if (!user.password) {
                console.log('❌ User has no password set');
                throw new Error('Usuario sin contraseña configurada');
            }
            
            if (user.password !== password) {
                console.log('❌ Password mismatch');
                throw new Error('Contraseña incorrecta');
            }
            
            // Check status (super_admin doesn't need active status check)
            if (user.role !== 'super_admin' && user.status && user.status !== 'active') {
                console.log('❌ User inactive, status:', user.status);
                throw new Error('Usuario inactivo');
            }
            
            // Update last login
            user.lastLogin = new Date().toISOString();
            
            const userData = {
                username: username,
                role: user.role,
                name: user.name,
                ...user
            };
            
            console.log('✅ Authentication successful!');
            console.log('✅ User role:', userData.role);
            console.log('✅ User name:', userData.name);
            
            return userData;
        }

        // Login form handler - will be set up in initializeApp

        // Logout function
        function logout() {
            sessionStorage.removeItem('currentUser');
            currentUser = null;
            currentSupervisor = null;
            
            hideAllViews();
            elements.loginView.classList.remove('hidden');
            
            // Reset form
            elements.loginForm.reset();
            elements.errorMessage.classList.add('hidden');
            
            showSuccess('Sesión cerrada correctamente');
        }

        /**
         * Super Admin Functions
         */
        
        // Load super admin view
        function loadSuperAdminView() {
            console.log('Loading super admin view...');
            
            if (elements.superAdminView) {
                elements.superAdminView.classList.remove('hidden');
                console.log('Super admin view shown');
                
                // Load data
                updateSystemStats();
                loadAllUsers();
                
                console.log('Super admin view loaded successfully');
            } else {
                console.error('Super admin view element not found!');
                showError('Error: No se pudo cargar el panel de administrador');
            }
        }
        
        // Switch between admin tabs
        function switchAdminTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-cnci-blue', 'text-cnci-blue');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            document.getElementById(`admin-tab-${tabName}`).classList.add('active', 'border-cnci-blue', 'text-cnci-blue');
            document.getElementById(`admin-tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        
            // Update content
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`admin-content-${tabName}`).classList.remove('hidden');

            if (tabName === 'users') {
                loadAllUsers();
            } else if (tabName === 'modules') {
                loadModulesTable();
            } else {
                updateSystemStats();
            }
        }

        // Update system statistics
        function updateSystemStats() {
            const users = Object.values(systemData.users);
            const supervisors = users.filter(u => u.role === 'supervisor');
            let totalAsesores = users.filter(u => u.role === 'asesor').length;
            let totalEvaluations = 0;
            
            // Count asesores from supervisors and evaluations
            supervisors.forEach(sup => {
                if (sup.asesores) {
                    Object.values(sup.asesores).forEach(moduleAsesores => {
                        totalAsesores += moduleAsesores.length;
                        moduleAsesores.forEach(asesor => {
                            if (asesor.categories) {
                                totalEvaluations += asesor.categories.length;
                            }
                        });
                    });
                }
            });

            // Count active modules
            const activeModulesCount = Object.values(systemData.config.modules).filter(m => m.status === 'active').length;
            
            // Update UI
            document.getElementById('totalSupervisors').textContent = supervisors.length;
            document.getElementById('totalAsesores').textContent = totalAsesores;
            document.getElementById('totalEvaluations').textContent = totalEvaluations;
            document.querySelector('#admin-content-dashboard .p-6:nth-child(3) p:last-child').textContent = activeModulesCount;
        }

        // Load all users in table
        function loadAllUsers() {
            const tbody = elements.usersTableBody;
            tbody.innerHTML = '';
            
            Object.entries(systemData.users).forEach(([username, userData]) => {
                if (username === 'admin') return; // Skip admin from table
                
                const row = createUserTableRow(username, userData);
                tbody.appendChild(row);
            });
        }
        
        // Load all modules in table
        function loadModulesTable() {
            const tbody = document.getElementById('modulesTableBody');
            tbody.innerHTML = '';
            
            Object.values(systemData.config.modules).forEach(module => {
                const row = createModuleTableRow(module);
                tbody.appendChild(row);
            });
        }
        
        // Create user table row
        function createUserTableRow(username, userData) {
            const row = document.createElement('tr');
            const statusClass = userData.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const roleClass = userData.role === 'supervisor' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${username}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${userData.name}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${roleClass}">
                        ${userData.role === 'supervisor' ? 'Supervisor' : 'Asesor'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${userData.status === 'active' ? 'Activo' : 'Inactivo'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button onclick="editUser('${username}')" class="text-cnci-blue hover:text-blue-700 transition-colors">Editar</button>
                    <button onclick="toggleUserStatus('${username}')" class="text-yellow-600 hover:text-yellow-700 transition-colors">
                        ${userData.status === 'active' ? 'Desactivar' : 'Activar'}
                    </button>
                    <button onclick="deleteUser('${username}')" class="text-red-600 hover:text-red-700 transition-colors">Eliminar</button>
                </td>
            `;
            return row;
        }

        // Create module table row
        function createModuleTableRow(module) {
            const row = document.createElement('tr');
            let statusClass = 'bg-gray-100 text-gray-800';
            let statusText = 'Desconocido';
            if (module.status === 'active') {
                statusClass = 'bg-green-100 text-green-800';
                statusText = 'Activo';
            } else if (module.status === 'paused') {
                statusClass = 'bg-yellow-100 text-yellow-800';
                statusText = 'En Pausa';
            } else if (module.status === 'closed') {
                statusClass = 'bg-red-100 text-red-800';
                statusText = 'Cerrado';
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${module.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${module.name}</td>
                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${module.description}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button onclick="openModuleModal('${module.id}')" class="text-cnci-blue hover:text-blue-700 transition-colors">Editar</button>
                    <button onclick="deleteModule('${module.id}')" class="text-red-600 hover:text-red-700 transition-colors">Eliminar</button>
                </td>
            `;
            return row;
        }
        
        // Filter users
        function filterUsers() {
            const roleFilter = document.getElementById('roleFilter').value;
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const rows = elements.usersTableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const username = row.cells[0].textContent.toLowerCase();
                const name = row.cells[1].textContent.toLowerCase();
                const role = row.cells[2].textContent.toLowerCase();
                
                const matchesRole = !roleFilter || role.includes(roleFilter);
                const matchesSearch = !searchTerm || username.includes(searchTerm) || name.includes(searchTerm);
                
                row.style.display = matchesRole && matchesSearch ? '' : 'none';
            });
        }

        // Create user modal functions
        function openCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
            document.getElementById('createUserForm').reset();
        }

        // Handle create user form
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUserUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            // Validate
            if (systemData.users[username]) {
                showError('El nombre de usuario ya existe');
                return;
            }
            
            // Create user
            const newUser = {
                password: password,
                role: role,
                name: name,
                email: `${username}@cnci.com`,
                status: 'active',
                createdAt: new Date().toISOString().split('T')[0],
                lastLogin: null,
                syncVersion: 1
            };
            
            if (role === 'supervisor') {
                newUser.asesores = {};
                newUser.permissions = ['manage_asesores', 'edit_titles', 'export_data'];
            } else if (role === 'asesor') {
                newUser.moduleData = {};
                newUser.currentModule = 'M1';
                newUser.department = 'General';
                newUser.supervisor = null;
                // Initialize with default module data
                Object.keys(systemData.config.modules).forEach(moduleId => {
                    if (!newUser.moduleData[moduleId]) {
                        newUser.moduleData[moduleId] = {
                            categories: [],
                            badges: [],
                            performance: {}
                        };
                    }
                });
            }
            
            systemData.users[username] = newUser;
            
            // Sync with Firebase if connected
            if (isFirebaseConnected) {
                try {
                    await db.collection('users').doc(username).set(newUser);
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            }
            
            closeCreateUserModal();
            loadAllUsers();
            updateSystemStats();
            showSuccess('Usuario creado correctamente');
        });

        // Edit user functions
        function editUser(username) {
            editingUserId = username;
            const userData = systemData.users[username];
            
            document.getElementById('editUserName').value = userData.name;
            document.getElementById('editUserUsername').value = username;
            document.getElementById('editUserRole').value = userData.role;
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('editUserForm').reset();
            document.getElementById('resetPassword').checked = false;
            document.getElementById('newPassword').classList.add('hidden');
            editingUserId = null;
        }

        // Handle reset password checkbox
        document.getElementById('resetPassword').addEventListener('change', (e) => {
            const passwordField = document.getElementById('newPassword');
            if (e.target.checked) {
                passwordField.classList.remove('hidden');
                passwordField.required = true;
            } else {
                passwordField.classList.add('hidden');
                passwordField.required = false;
                passwordField.value = '';
            }
        });

        // Handle edit user form
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newName = document.getElementById('editUserName').value.trim();
            const newUsername = document.getElementById('editUserUsername').value.trim();
            const newRole = document.getElementById('editUserRole').value;
            const resetPassword = document.getElementById('resetPassword').checked;
            const newPassword = document.getElementById('newPassword').value;
            
            // Validate username change
            if (newUsername !== editingUserId && systemData.users[newUsername]) {
                showError('El nuevo nombre de usuario ya existe');
                return;
            }
            
            const userData = systemData.users[editingUserId];
            
            // Update user data
            userData.name = newName;
            userData.role = newRole;
            userData.email = `${newUsername}@cnci.com`;
            userData.lastUpdate = new Date().toISOString();
            
            if (resetPassword && newPassword) {
                userData.password = newPassword;
            }
            
            // Handle username change
            if (newUsername !== editingUserId) {
                systemData.users[newUsername] = userData;
                delete systemData.users[editingUserId];
                
                // Update Firebase
                if (isFirebaseConnected) {
                    try {
                        await db.collection('users').doc(newUsername).set(userData);
                        await db.collection('users').doc(editingUserId).delete();
                    } catch (error) {
                        console.error('Error updating Firebase:', error);
                    }
                }
            } else if (isFirebaseConnected) {
                try {
                    await db.collection('users').doc(editingUserId).update(userData);
                } catch (error) {
                    console.error('Error updating Firebase:', error);
                }
            }
            
            closeEditUserModal();
            loadAllUsers();
            showSuccess('Usuario actualizado correctamente');
        });

        // Toggle user status
        async function toggleUserStatus(username) {
            const userData = systemData.users[username];
            userData.status = userData.status === 'active' ? 'inactive' : 'active';
            userData.lastUpdate = new Date().toISOString();
            
            // Update Firebase
            if (isFirebaseConnected) {
                try {
                    await db.collection('users').doc(username).update({ 
                        status: userData.status,
                        lastUpdate: userData.lastUpdate
                    });
                } catch (error) {
                    console.error('Error updating Firebase:', error);
                }
            }
            
            loadAllUsers();
            showSuccess(`Usuario ${userData.status === 'active' ? 'activado' : 'desactivado'} correctamente`);
        }

        // Delete user
        async function deleteUser(username) {
            if (confirm('¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.')) {
                delete systemData.users[username];
                
                // Delete from Firebase
                if (isFirebaseConnected) {
                    try {
                        await db.collection('users').doc(username).delete();
                    } catch (error) {
                        console.error('Error deleting from Firebase:', error);
                    }
                }
                
                loadAllUsers();
                updateSystemStats();
                showSuccess('Usuario eliminado correctamente');
            }
        }

        /**
         * Module Management Functions
         */
        
        // Open/Close module management modal
        function openModuleModal(moduleId = null) {
            editingModuleId = moduleId;
            const modalTitle = document.getElementById('moduleModalTitle');
            const form = document.getElementById('moduleForm');
            form.reset();

            if (moduleId) {
                const module = systemData.config.modules[moduleId];
                if (!module) {
                    showError('Módulo no encontrado');
                    return;
                }
                modalTitle.textContent = `Editar Módulo: ${module.name}`;
                document.getElementById('moduleId').value = module.id;
                document.getElementById('moduleId').disabled = true;
                document.getElementById('moduleName').value = module.name;
                document.getElementById('moduleDescriptionModal').value = module.description;
                document.getElementById('moduleStatus').value = module.status;
            } else {
                modalTitle.textContent = 'Crear Módulo';
                document.getElementById('moduleId').disabled = false;
            }

            document.getElementById('manageModulesModal').classList.remove('hidden');
        }

        function closeModuleModal() {
            document.getElementById('manageModulesModal').classList.add('hidden');
            document.getElementById('moduleForm').reset();
        }

        document.getElementById('moduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('moduleId').value.trim();
            const name = document.getElementById('moduleName').value.trim();
            const description = document.getElementById('moduleDescriptionModal').value.trim();
            const status = document.getElementById('moduleStatus').value;

            if (!id || !name) {
                showError('ID y Nombre del módulo son obligatorios.');
                return;
            }

            const newModule = {
                id,
                name,
                title: name,
                description,
                status,
                categories: systemData.config.modules[id]?.categories || []
            };

            systemData.config.modules[id] = newModule;
            
            // Update Firebase
            if (isFirebaseConnected) {
                try {
                    await db.collection('config').doc('modules').set({
                        modules: systemData.config.modules,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving module to Firebase:', error);
                }
            }
            
            closeModuleModal();
            loadModulesTable();
            updateSystemStats();
            showSuccess('Módulo guardado correctamente.');
        });

        async function deleteModule(moduleId) {
            if (confirm('¿Estás seguro de que deseas eliminar este módulo? Se eliminarán todas sus configuraciones.')) {
                delete systemData.config.modules[moduleId];
                
                if (isFirebaseConnected) {
                    try {
                        await db.collection('config').doc('modules').set({
                            modules: systemData.config.modules,
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (error) {
                        console.error('Error deleting module from Firebase:', error);
                    }
                }
                
                loadModulesTable();
                updateSystemStats();
                showSuccess('Módulo eliminado correctamente.');
            }
        }
        
        // Get current module categories (custom or default)
        function getCurrentModuleCategories() {
            const supervisorKey = currentSupervisor.username;
            const moduleKey = currentModule;
            
            if (customModuleCategories[supervisorKey] && customModuleCategories[supervisorKey][moduleKey]) {
                return customModuleCategories[supervisorKey][moduleKey];
            }
            
            // Return default module categories
            return systemData.config.modules[currentModule]?.categories || [];
        }

        // Open category manager modal
        function openCategoryManagerModal() {
            const modal = document.getElementById('categoryManagerModal');
            const moduleNameSpan = document.getElementById('categoryModuleName');
            
            moduleNameSpan.textContent = systemData.config.modules[currentModule].name;
            
            // Load current categories for editing
            const currentCategories = getCurrentModuleCategories();
            tempCategoryConfig = JSON.parse(JSON.stringify(currentCategories)); // Deep copy
            
            renderCategoriesEditor();
            modal.classList.remove('hidden');
        }

        // Close category manager modal
        function closeCategoryManagerModal() {
            document.getElementById('categoryManagerModal').classList.add('hidden');
            tempCategoryConfig = null;
        }

        // Render categories editor
        function renderCategoriesEditor() {
            const container = document.getElementById('categoriesEditor');
            container.innerHTML = '';
            
            if (!tempCategoryConfig || tempCategoryConfig.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">📋</div>
                        <p>No hay categorías configuradas</p>
                        <p class="text-sm">Usa el botón "Añadir Nueva Categoría" para comenzar</p>
                    </div>
                `;
                return;
            }
            
            tempCategoryConfig.forEach((category, categoryIndex) => {
                const categoryCard = createCategoryEditorCard(category, categoryIndex);
                container.appendChild(categoryCard);
            });
        }

        // Create category editor card
        function createCategoryEditorCard(category, categoryIndex) {
            const card = document.createElement('div');
            card.className = 'border border-gray-200 rounded-lg p-6 bg-gray-50';
            
            const colorOptions = [
                { value: 'blue', label: 'Azul', class: 'bg-blue-500' },
                { value: 'green', label: 'Verde', class: 'bg-green-500' },
                { value: 'purple', label: 'Morado', class: 'bg-purple-500' },
                { value: 'orange', label: 'Naranja', class: 'bg-orange-500' },
                { value: 'red', label: 'Rojo', class: 'bg-red-500' },
                { value: 'yellow', label: 'Amarillo', class: 'bg-yellow-500' },
                { value: 'indigo', label: 'Índigo', class: 'bg-indigo-500' },
                { value: 'pink', label: 'Rosa', class: 'bg-pink-500' }
            ];
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">Categoría ${categoryIndex + 1}</h4>
                    <button onclick="removeCategory(${categoryIndex})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                        🗑️ Eliminar
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Categoría</label>
                        <input type="text" value="${category.name}" 
                               onchange="updateCategoryName(${categoryIndex}, this.value)"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                        <select onchange="updateCategoryColor(${categoryIndex}, this.value)"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                            ${colorOptions.map(option => `
                                <option value="${option.value}" ${category.color === option.value ? 'selected' : ''}>
                                    ${option.label}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="font-medium text-gray-800">Criterios de Evaluación</h5>
                        <button onclick="addCriterion(${categoryIndex})" class="text-green-600 hover:text-green-800 text-sm font-medium">
                            ➕ Añadir Criterio
                        </button>
                    </div>
                    
                    <div id="criteria-${categoryIndex}" class="space-y-3">
                        ${category.criteria.map((criterion, criterionIndex) => `
                            <div class="flex items-center space-x-3 bg-white p-3 rounded border">
                                <input type="text" value="${criterion.name}" 
                                       onchange="updateCriterionName(${categoryIndex}, ${criterionIndex}, this.value)"
                                       placeholder="Nombre del criterio"
                                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:border-cnci-blue focus:outline-none">
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-600">Peso:</label>
                                    <input type="number" min="0" max="1" step="0.1" value="${criterion.weight}" 
                                           onchange="updateCriterionWeight(${categoryIndex}, ${criterionIndex}, this.value)"
                                           class="w-20 border border-gray-300 rounded px-2 py-1 text-sm focus:border-cnci-blue focus:outline-none">
                                </div>
                                <button onclick="removeCriterion(${categoryIndex}, ${criterionIndex})" 
                                        class="text-red-600 hover:text-red-800 text-sm">
                                    🗑️
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-2 text-xs text-gray-500">
                        Peso total: <span id="weight-total-${categoryIndex}">${category.criteria.reduce((sum, c) => sum + c.weight, 0).toFixed(1)}</span>
                        ${category.criteria.reduce((sum, c) => sum + c.weight, 0) !== 1.0 ? 
                            '<span class="text-red-600 ml-2">⚠️ El peso total debe ser 1.0</span>' : 
                            '<span class="text-green-600 ml-2">✅</span>'
                        }
                    </div>
                </div>
            `;
            
            return card;
        }

        // Add new category
        function addNewCategory() {
            if (!tempCategoryConfig) {
                tempCategoryConfig = [];
            }
            
            const newCategory = {
                id: 'custom_' + Date.now(),
                name: 'Nueva Categoría',
                color: 'blue',
                criteria: [
                    { name: 'Criterio 1', weight: 1.0 }
                ]
            };
            
            tempCategoryConfig.push(newCategory);
            renderCategoriesEditor();
        }

        // Remove category
        function removeCategory(categoryIndex) {
            if (confirm('¿Estás seguro de que deseas eliminar esta categoría?')) {
                tempCategoryConfig.splice(categoryIndex, 1);
                renderCategoriesEditor();
            }
        }

        // Update category name
        function updateCategoryName(categoryIndex, newName) {
            tempCategoryConfig[categoryIndex].name = newName.trim() || 'Sin nombre';
        }

        // Update category color
        function updateCategoryColor(categoryIndex, newColor) {
            tempCategoryConfig[categoryIndex].color = newColor;
        }

        // Add criterion to category
        function addCriterion(categoryIndex) {
            const newCriterion = {
                name: 'Nuevo Criterio',
                weight: 0.1
            };
            
            tempCategoryConfig[categoryIndex].criteria.push(newCriterion);
            renderCategoriesEditor();
        }

        // Remove criterion
        function removeCriterion(categoryIndex, criterionIndex) {
            if (tempCategoryConfig[categoryIndex].criteria.length <= 1) {
                alert('Una categoría debe tener al menos un criterio');
                return;
            }
            
            if (confirm('¿Estás seguro de que deseas eliminar este criterio?')) {
                tempCategoryConfig[categoryIndex].criteria.splice(criterionIndex, 1);
                renderCategoriesEditor();
            }
        }

        // Update criterion name
        function updateCriterionName(categoryIndex, criterionIndex, newName) {
            tempCategoryConfig[categoryIndex].criteria[criterionIndex].name = newName.trim() || 'Sin nombre';
        }

        // Update criterion weight
        function updateCriterionWeight(categoryIndex, criterionIndex, newWeight) {
            const weight = parseFloat(newWeight) || 0;
            tempCategoryConfig[categoryIndex].criteria[criterionIndex].weight = Math.max(0, Math.min(1, weight));
            
            // Update weight total display
            const totalWeight = tempCategoryConfig[categoryIndex].criteria.reduce((sum, c) => sum + c.weight, 0);
            const totalSpan = document.getElementById(`weight-total-${categoryIndex}`);
            if (totalSpan) {
                totalSpan.textContent = totalWeight.toFixed(1);
                
                // Update warning
                const parentDiv = totalSpan.parentElement;
                const existingWarning = parentDiv.querySelector('.text-red-600, .text-green-600');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                const warningSpan = document.createElement('span');
                warningSpan.className = 'ml-2';
                if (Math.abs(totalWeight - 1.0) > 0.01) {
                    warningSpan.className += ' text-red-600';
                    warningSpan.textContent = '⚠️ El peso total debe ser 1.0';
                } else {
                    warningSpan.className += ' text-green-600';
                    warningSpan.textContent = '✅';
                }
                parentDiv.appendChild(warningSpan);
            }
        }

        // Save category configuration
        async function saveCategoryConfiguration() {
            if (!tempCategoryConfig || tempCategoryConfig.length === 0) {
                showError('Debe haber al menos una categoría configurada');
                return;
            }
            
            // Validate configuration
            let hasErrors = false;
            const errors = [];
            
            tempCategoryConfig.forEach((category, index) => {
                if (!category.name.trim()) {
                    errors.push(`Categoría ${index + 1}: Nombre requerido`);
                    hasErrors = true;
                }
                
                if (!category.criteria || category.criteria.length === 0) {
                    errors.push(`Categoría ${index + 1}: Debe tener al menos un criterio`);
                    hasErrors = true;
                } else {
                    const totalWeight = category.criteria.reduce((sum, c) => sum + c.weight, 0);
                    if (Math.abs(totalWeight - 1.0) > 0.01) {
                        errors.push(`Categoría ${index + 1}: El peso total debe ser 1.0 (actual: ${totalWeight.toFixed(1)})`);
                        hasErrors = true;
                    }
                    
                    category.criteria.forEach((criterion, critIndex) => {
                        if (!criterion.name.trim()) {
                            errors.push(`Categoría ${index + 1}, Criterio ${critIndex + 1}: Nombre requerido`);
                            hasErrors = true;
                        }
                    });
                }
            });
            
            if (hasErrors) {
                showError('Errores de validación:\n' + errors.join('\n'));
                return;
            }
            
            try {
                showLoading(true);
                
                // Initialize custom categories structure
                const supervisorKey = currentSupervisor.username;
                if (!customModuleCategories[supervisorKey]) {
                    customModuleCategories[supervisorKey] = {};
                }
                
                // Save custom configuration
                customModuleCategories[supervisorKey][currentModule] = JSON.parse(JSON.stringify(tempCategoryConfig));
                
                // Update existing asesores with new category structure
                if (currentSupervisor.asesores && currentSupervisor.asesores[currentModule]) {
                    currentSupervisor.asesores[currentModule].forEach(asesor => {
                        // Backup existing scores
                        const existingScores = {};
                        if (asesor.categories) {
                            asesor.categories.forEach(cat => {
                                existingScores[cat.id] = {
                                    score: cat.score,
                                    criteria: {}
                                };
                                if (cat.criteria) {
                                    cat.criteria.forEach(crit => {
                                        existingScores[cat.id].criteria[crit.name] = crit.score;
                                    });
                                }
                            });
                        }
                        
                        // Create new categories based on configuration
                        asesor.categories = tempCategoryConfig.map(catConfig => {
                            const existingCat = existingScores[catConfig.id];
                            return {
                                id: catConfig.id,
                                name: catConfig.name,
                                score: existingCat ? existingCat.score : 0,
                                color: catConfig.color,
                                criteria: catConfig.criteria.map(critConfig => ({
                                    name: critConfig.name,
                                    score: existingCat && existingCat.criteria[critConfig.name] ? 
                                           existingCat.criteria[critConfig.name] : 0,
                                    weight: critConfig.weight
                                })),
                                supervisionComment: existingCat ? 
                                    (asesor.categories.find(c => c.id === catConfig.id)?.supervisionComment || 'Actualizado con nueva configuración.') :
                                    'Configurado con nuevas categorías.',
                                qualityComment: existingCat ? 
                                    (asesor.categories.find(c => c.id === catConfig.id)?.qualityComment || 'Pendiente de evaluación.') :
                                    'Pendiente de evaluación.',
                                lastEvaluation: existingCat ? 
                                    (asesor.categories.find(c => c.id === catConfig.id)?.lastEvaluation || null) :
                                    null,
                                evaluator: currentSupervisor.username
                            };
                        });
                        
                        // Update standalone user data
                        if (systemData.users[asesor.username]) {
                            const standaloneUser = systemData.users[asesor.username];
                            if (standaloneUser.moduleData && standaloneUser.moduleData[currentModule]) {
                                standaloneUser.moduleData[currentModule].categories = asesor.categories;
                            }
                        }
                    });
                }
                
                // Save to Firebase if connected
                if (isFirebaseConnected) {
                    try {
                        // Save custom categories configuration
                        await db.collection('custom_categories').doc(supervisorKey).set({
                            [currentModule]: tempCategoryConfig,
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        
                        // Update supervisor data
                        await db.collection('users').doc(supervisorKey).update({
                            asesores: currentSupervisor.asesores,
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Update standalone users
                        if (currentSupervisor.asesores && currentSupervisor.asesores[currentModule]) {
                            const batch = db.batch();
                            currentSupervisor.asesores[currentModule].forEach(asesor => {
                                if (systemData.users[asesor.username]) {
                                    const userRef = db.collection('users').doc(asesor.username);
                                    batch.update(userRef, {
                                        moduleData: systemData.users[asesor.username].moduleData,
                                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }
                            });
                            await batch.commit();
                        }
                    } catch (error) {
                        console.error('Error saving to Firebase:', error);
                    }
                }
                
                closeCategoryManagerModal();
                loadAsesoresTable();
                showSuccess('Configuración de categorías guardada correctamente');
                
            } catch (error) {
                console.error('Error saving category configuration:', error);
                showError('Error al guardar la configuración: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Reset module categories to default
        async function resetModuleCategories() {
            if (!confirm('¿Estás seguro de que deseas restaurar las categorías por defecto? Se perderán todas las personalizaciones.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                const supervisorKey = currentSupervisor.username;
                
                // Remove custom configuration
                if (customModuleCategories[supervisorKey]) {
                    delete customModuleCategories[supervisorKey][currentModule];
                    if (Object.keys(customModuleCategories[supervisorKey]).length === 0) {
                        delete customModuleCategories[supervisorKey];
                    }
                }
                
                // Reset asesores to default categories
                if (currentSupervisor.asesores && currentSupervisor.asesores[currentModule]) {
                    const defaultCategories = systemData.config.modules[currentModule].categories;
                    
                    currentSupervisor.asesores[currentModule].forEach(asesor => {
                        asesor.categories = defaultCategories.map(catConfig => ({
                            id: catConfig.id,
                            name: catConfig.name,
                            score: 0,
                            color: catConfig.color,
                            criteria: catConfig.criteria.map(critConfig => ({
                                name: critConfig.name,
                                score: 0,
                                weight: critConfig.weight
                            })),
                            supervisionComment: 'Restaurado a configuración por defecto.',
                            qualityComment: 'Pendiente de evaluación.',
                            lastEvaluation: null,
                            evaluator: currentSupervisor.username
                        }));
                        
                        // Update standalone user
                        if (systemData.users[asesor.username]) {
                            const standaloneUser = systemData.users[asesor.username];
                            if (standaloneUser.moduleData && standaloneUser.moduleData[currentModule]) {
                                standaloneUser.moduleData[currentModule].categories = asesor.categories;
                            }
                        }
                    });
                }
                
                // Update Firebase
                if (isFirebaseConnected) {
                    try {
                        // Remove custom categories
                        await db.collection('custom_categories').doc(supervisorKey).update({
                            [currentModule]: firebase.firestore.FieldValue.delete()
                        });
                        
                        // Update supervisor and users
                        await db.collection('users').doc(supervisorKey).update({
                            asesores: currentSupervisor.asesores,
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        if (currentSupervisor.asesores && currentSupervisor.asesores[currentModule]) {
                            const batch = db.batch();
                            currentSupervisor.asesores[currentModule].forEach(asesor => {
                                if (systemData.users[asesor.username]) {
                                    const userRef = db.collection('users').doc(asesor.username);
                                    batch.update(userRef, {
                                        moduleData: systemData.users[asesor.username].moduleData,
                                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                }
                            });
                            await batch.commit();
                        }
                    } catch (error) {
                        console.error('Error updating Firebase:', error);
                    }
                }
                
                loadAsesoresTable();
                showSuccess('Categorías restauradas a la configuración por defecto');
                
            } catch (error) {
                console.error('Error resetting categories:', error);
                showError('Error al restaurar categorías: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Preview category changes
        function previewCategoryChanges() {
            const modal = document.getElementById('categoryPreviewModal');
            const content = document.getElementById('categoryPreviewContent');
            
            const currentCategories = getCurrentModuleCategories();
            
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Configuración Actual - ${systemData.config.modules[currentModule].name}</h4>
                    <p class="text-sm text-gray-600">Esta es la configuración que se aplicará a todos los asesores del módulo.</p>
                </div>
                
                <div class="space-y-4">
                    ${currentCategories.map((category, index) => `
                        <div class="border border-gray-200 rounded-lg p-4 bg-gradient-to-r from-${category.color}-50 to-${category.color}-100">
                            <div class="flex items-center justify-between mb-3">
                                <h5 class="font-semibold text-gray-800">${category.name}</h5>
                                <span class="px-2 py-1 bg-${category.color}-200 text-${category.color}-800 rounded text-sm">
                                    ${category.color}
                                </span>
                            </div>
                            
                            <div class="space-y-2">
                                <h6 class="text-sm font-medium text-gray-700">Criterios de Evaluación:</h6>
                                ${category.criteria.map(criterion => `
                                    <div class="flex justify-between items-center bg-white bg-opacity-50 rounded px-3 py-2">
                                        <span class="text-sm text-gray-700">${criterion.name}</span>
                                        <span class="text-sm font-medium text-gray-600">Peso: ${(criterion.weight * 100).toFixed(0)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mt-3 text-xs text-gray-600">
                                Total de criterios: ${category.criteria.length} | 
                                Peso total: ${category.criteria.reduce((sum, c) => sum + c.weight, 0).toFixed(1)}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h5 class="font-medium text-blue-800 mb-2">Información Importante:</h5>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Esta configuración se aplicará a todos los asesores existentes y nuevos del módulo</li>
                        <li>• Las puntuaciones existentes se conservarán cuando sea posible</li>
                        <li>• Los criterios eliminados perderán sus puntuaciones</li>
                        <li>• Los nuevos criterios comenzarán con puntuación 0</li>
                    </ul>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Close category preview modal
        function closeCategoryPreviewModal() {
            document.getElementById('categoryPreviewModal').classList.add('hidden');
        }

        /**
         * Supervisor Functions
         */
        
        // Load supervisor view
        async function loadSupervisorView(userData) {
            currentSupervisor = userData;
            elements.supervisorView.classList.remove('hidden');
            
            document.getElementById('supervisorName').textContent = userData.name;
            
            // Load custom categories from Firebase if connected
            if (isFirebaseConnected) {
                try {
                    const customCategoriesDoc = await db.collection('custom_categories').doc(userData.username).get();
                    if (customCategoriesDoc.exists) {
                        const customData = customCategoriesDoc.data();
                        if (!customModuleCategories[userData.username]) {
                            customModuleCategories[userData.username] = {};
                        }
                        Object.assign(customModuleCategories[userData.username], customData);
                    }
                } catch (error) {
                    console.error('Error loading custom categories:', error);
                }
            }
            
            // Initialize module selectors
            initializeModuleSelectors();
            
            // Load current titles
            document.getElementById('mainTitle').value = systemData.config.loginTitle;
            document.getElementById('subtitle').value = systemData.config.loginSubtitle;
            
            loadAsesoresTable();
        }

        // Update login titles
        async function updateLoginTitles() {
            const mainTitle = document.getElementById('mainTitle').value.trim();
            const subtitle = document.getElementById('subtitle').value.trim();
            
            if (!mainTitle || !subtitle) {
                showError('Por favor, completa ambos campos');
                return;
            }
            
            // Update system config
            systemData.config.loginTitle = mainTitle;
            systemData.config.loginSubtitle = subtitle;
            systemData.config.lastUpdate = new Date().toISOString();
            
            // Update Firebase
            if (isFirebaseConnected) {
                try {
                    await db.collection('config').doc('system').update({
                        loginTitle: mainTitle,
                        loginSubtitle: subtitle,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating Firebase:', error);
                }
            }
            
            // Update login screen immediately
            document.getElementById('loginTitle').textContent = mainTitle;
            document.getElementById('loginSubtitle').textContent = subtitle;
            
            showSuccess('Títulos actualizados correctamente');
        }

        // Load asesores table
        function loadAsesoresTable() {
            const tbody = elements.asesoresTableBody;
            tbody.innerHTML = '';
            
            const moduleAsesores = currentSupervisor.asesores && currentSupervisor.asesores[currentModule] 
                ? currentSupervisor.asesores[currentModule] 
                : [];
            
            if (moduleAsesores.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">👥</div>
                        <p>No hay asesores registrados para ${systemData.config.modules[currentModule].name}</p>
                        <p class="text-sm">Usa el botón "Añadir Asesor" para comenzar</p>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            moduleAsesores.forEach(asesor => {
                const row = createAsesorTableRow(asesor);
                tbody.appendChild(row);
            });
        }

        // Create asesor table row
        function createAsesorTableRow(asesor) {
            const row = document.createElement('tr');
            const generalScore = calculateGeneralScore(asesor.categories);
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${asesor.username}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${asesor.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">••••••••</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getScoreColor(generalScore)}">
                        ${generalScore.toFixed(1)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button onclick="openAsesorDetailsModal('${asesor.id}')" class="text-cnci-blue hover:text-blue-700 transition-colors">Detalles</button>
                    <button onclick="deleteAsesor('${asesor.id}')" class="text-red-600 hover:text-red-700 transition-colors">Eliminar</button>
                </td>
            `;
            return row;
        }

        // Get score color class
        function getScoreColor(score) {
            if (score >= 8) return 'bg-green-100 text-green-800';
            if (score >= 6) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        // Add asesor modal functions
        function openAddAsesorModal() {
            document.getElementById('addAsesorModal').classList.remove('hidden');
        }

        function closeAddAsesorModal() {
            document.getElementById('addAsesorModal').classList.add('hidden');
            document.getElementById('addAsesorForm').reset();
        }

        // Handle add asesor form
        document.getElementById('addAsesorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('newAsesorName').value.trim();
            const username = document.getElementById('newAsesorUsername').value.trim();
            const password = document.getElementById('newAsesorPassword').value;
            
            // Initialize asesores object if it doesn't exist
            if (!currentSupervisor.asesores) {
                currentSupervisor.asesores = {};
            }
            if (!currentSupervisor.asesores[currentModule]) {
                currentSupervisor.asesores[currentModule] = [];
            }
            
            // Validate username uniqueness
            const existingUsernames = currentSupervisor.asesores[currentModule].map(a => a.username);
            if (existingUsernames.includes(username) || systemData.users[username]) {
                showError('El nombre de usuario ya existe');
                return;
            }
            
            // Get current module configuration (custom or default)
            const moduleConfig = getCurrentModuleCategories();
            
            // Create categories based on current module configuration
            const categories = moduleConfig.map(catConfig => ({
                id: catConfig.id,
                name: catConfig.name,
                score: 0,
                color: catConfig.color,
                criteria: catConfig.criteria.map(criterion => ({
                    name: criterion.name,
                    score: 0,
                    weight: criterion.weight
                })),
                supervisionComment: 'Pendiente de evaluación.',
                qualityComment: 'Pendiente de evaluación.',
                lastEvaluation: null,
                evaluator: currentSupervisor.username
            }));
            
            // Create new asesor
            const newAsesor = {
                id: generateId(),
                username: username,
                name: name,
                password: password,
                module: currentModule,
                email: `${username}@cnci.com`,
                phone: '',
                department: 'General',
                supervisor: currentSupervisor.username,
                categories: categories,
                badges: [],
                performance: {
                    callsHandled: 0,
                    averageCallTime: '0:00',
                    customerSatisfaction: 0,
                    goalsAchieved: 0,
                    attendanceRate: 100
                },
                createdAt: new Date().toISOString().split('T')[0],
                lastUpdate: new Date().toISOString()
            };
            
            // Add to supervisor's asesores
            currentSupervisor.asesores[currentModule].push(newAsesor);
            
            // Also create as standalone user
            systemData.users[username] = {
                password: password,
                role: 'asesor',
                name: name,
                email: `${username}@cnci.com`,
                phone: '',
                department: 'General',
                supervisor: currentSupervisor.username,
                status: 'active',
                createdAt: new Date().toISOString().split('T')[0],
                lastLogin: null,
                currentModule: currentModule,
                moduleData: {
                    [currentModule]: {
                        categories: categories,
                        badges: [],
                        performance: newAsesor.performance
                    }
                }
            };
            
            // Initialize other modules with empty data
            Object.keys(systemData.config.modules).forEach(moduleId => {
                if (moduleId !== currentModule) {
                    systemData.users[username].moduleData[moduleId] = {
                        categories: [],
                        badges: [],
                        performance: {}
                    };
                }
            });
            
            // Update Firebase
            if (isFirebaseConnected) {
                try {
                    // Update supervisor data
                    await db.collection('users').doc(currentSupervisor.username).update({
                        asesores: currentSupervisor.asesores,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create standalone asesor user
                    await db.collection('users').doc(username).set(systemData.users[username]);
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            }
            
            closeAddAsesorModal();
            loadAsesoresTable();
            showSuccess('Asesor añadido correctamente');
        });

        // Clear table modal functions
        function openClearTableModal() {
            document.getElementById('clearTableModal').classList.remove('hidden');
        }

        function closeClearTableModal() {
            document.getElementById('clearTableModal').classList.add('hidden');
        }

        // Clear all asesores
        async function clearAllAsesores() {
            if (!currentSupervisor.asesores || !currentSupervisor.asesores[currentModule]) {
                closeClearTableModal();
                return;
            }
            
            const asesores = currentSupervisor.asesores[currentModule];
            
            // Remove from standalone users
            asesores.forEach(asesor => {
                delete systemData.users[asesor.username];
            });
            
            // Clear from supervisor
            currentSupervisor.asesores[currentModule] = [];
            
            // Update Firebase
            if (isFirebaseConnected) {
                try {
                    // Update supervisor
                    await db.collection('users').doc(currentSupervisor.username).update({
                        asesores: currentSupervisor.asesores,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Delete standalone users
                    const batch = db.batch();
                    asesores.forEach(asesor => {
                        const userRef = db.collection('users').doc(asesor.username);
                        batch.delete(userRef);
                    });
                    await batch.commit();
                } catch (error) {
                    console.error('Error updating Firebase:', error);
                }
            }
            
            closeClearTableModal();
            loadAsesoresTable();
            showSuccess('Todos los asesores han sido eliminados');
        }

        // Delete individual asesor
        async function deleteAsesor(asesorId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este asesor?')) return;
            
            const moduleAsesores = currentSupervisor.asesores[currentModule];
            const asesorIndex = moduleAsesores.findIndex(a => a.id === asesorId);
            
            if (asesorIndex === -1) return;
            
            const asesor = moduleAsesores[asesorIndex];
            
            // Remove from supervisor's list
            moduleAsesores.splice(asesorIndex, 1);
            
            // Remove from standalone users
            delete systemData.users[asesor.username];
            
            // Update Firebase
            if (isFirebaseConnected) {
                try {
                    // Update supervisor
                    await db.collection('users').doc(currentSupervisor.username).update({
                        asesores: currentSupervisor.asesores,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Delete standalone user
                    await db.collection('users').doc(asesor.username).delete();
                } catch (error) {
                    console.error('Error updating Firebase:', error);
                }
            }
            
            loadAsesoresTable();
            showSuccess('Asesor eliminado correctamente');
        }

        // Export asesores data
        function exportAsesoresData() {
            const moduleAsesores = currentSupervisor.asesores && currentSupervisor.asesores[currentModule] 
                ? currentSupervisor.asesores[currentModule] 
                : [];
            
            if (moduleAsesores.length === 0) {
                showError('No hay datos para exportar');
                return;
            }
            
            const exportData = {
                exportInfo: {
                    timestamp: new Date().toISOString(),
                    module: currentModule,
                    moduleName: systemData.config.modules[currentModule].name,
                    supervisor: currentSupervisor.name,
                    totalAsesores: moduleAsesores.length
                },
                asesores: moduleAsesores
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `asesores_${currentModule}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess('Datos exportados correctamente');
        }

        // Export asesores data as CSV (Supervisor)
        function exportAsesoresCSV() {
            const moduleAsesores = currentSupervisor.asesores && currentSupervisor.asesores[currentModule] 
                ? currentSupervisor.asesores[currentModule] 
                : [];
            
            if (moduleAsesores.length === 0) {
                showError('No hay datos para exportar');
                return;
            }

            try {
                // Prepare CSV data
                const csvData = [];
                
                // Create headers
                const baseHeaders = [
                    'Usuario', 'Nombre', 'Email', 'Teléfono', 'Departamento', 'Módulo', 'Promedio General'
                ];
                
                // Add category headers
                const moduleConfig = systemData.config.modules[currentModule];
                const categoryHeaders = [];
                moduleConfig.categories.forEach(category => {
                    categoryHeaders.push(`${category.name} - Puntuación`);
                    category.criteria.forEach(criterion => {
                        categoryHeaders.push(`${category.name} - ${criterion.name}`);
                    });
                    categoryHeaders.push(`${category.name} - Comentario Supervisión`);
                    categoryHeaders.push(`${category.name} - Comentario Calidad`);
                });

                const headers = [...baseHeaders, ...categoryHeaders, 'Insignias', 'Fecha Creación', 'Última Actualización'];
                csvData.push(headers);

                // Add asesor data
                moduleAsesores.forEach(asesor => {
                    const generalScore = calculateGeneralScore(asesor.categories);
                    
                    const baseRow = [
                        asesor.username,
                        asesor.name,
                        asesor.email || '',
                        asesor.phone || '',
                        asesor.department || '',
                        asesor.module,
                        generalScore.toFixed(1)
                    ];

                    // Add category data
                    const categoryData = [];
                    moduleConfig.categories.forEach(categoryConfig => {
                        const category = asesor.categories.find(c => c.id === categoryConfig.id);
                        if (category) {
                            categoryData.push(category.score.toFixed(1));
                            category.criteria.forEach(criterion => {
                                categoryData.push(criterion.score.toFixed(1));
                            });
                            categoryData.push(category.supervisionComment || '');
                            categoryData.push(category.qualityComment || '');
                        } else {
                            // Empty category
                            categoryData.push('0.0');
                            categoryConfig.criteria.forEach(() => {
                                categoryData.push('0.0');
                            });
                            categoryData.push('');
                            categoryData.push('');
                        }
                    });

                    const badges = asesor.badges ? asesor.badges.map(b => b.title).join('; ') : '';
                    const additionalData = [
                        badges,
                        asesor.createdAt || '',
                        asesor.lastUpdate || ''
                    ];

                    const row = [...baseRow, ...categoryData, ...additionalData];
                    csvData.push(row);
                });

                // Convert to CSV string
                const csvContent = csvData.map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                // Create and download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `asesores_${currentModule}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showSuccess('Datos CSV exportados correctamente');

            } catch (error) {
                console.error('Error exporting CSV:', error);
                showError('Error al exportar CSV: ' + error.message);
            }
        }

        // Import asesores CSV (Supervisor)
        async function importAsesoresCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showLoading(true);

                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showError('El archivo CSV debe contener al menos una fila de encabezados y una fila de datos');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                
                // Validate required headers
                const requiredHeaders = ['Usuario', 'Nombre'];
                const hasRequiredHeaders = requiredHeaders.every(header => 
                    headers.some(h => h.toLowerCase().includes(header.toLowerCase()))
                );

                if (!hasRequiredHeaders) {
                    showError('El archivo CSV debe contener al menos las columnas: Usuario, Nombre');
                    return;
                }

                // Initialize asesores array if it doesn't exist
                if (!currentSupervisor.asesores) {
                    currentSupervisor.asesores = {};
                }
                if (!currentSupervisor.asesores[currentModule]) {
                    currentSupervisor.asesores[currentModule] = [];
                }

                let importedCount = 0;
                let updatedCount = 0;
                let errorCount = 0;

                // Get module configuration
                const moduleConfig = systemData.config.modules[currentModule];

                // Process data rows
                for (let i = 1; i < lines.length; i++) {
                    try {
                        const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                        
                        if (values.length < 2 || !values[0] || !values[1]) {
                            errorCount++;
                            continue;
                        }

                        const username = values[0];
                        const name = values[1];

                        // Check if asesor already exists
                        const existingAsesorIndex = currentSupervisor.asesores[currentModule].findIndex(a => a.username === username);
                        
                        // Create categories based on module configuration
                        const categories = moduleConfig.categories.map(catConfig => ({
                            id: catConfig.id,
                            name: catConfig.name,
                            score: 0,
                            color: catConfig.color,
                            criteria: catConfig.criteria.map(criterion => ({
                                name: criterion.name,
                                score: 0,
                                weight: criterion.weight
                            })),
                            supervisionComment: 'Importado desde CSV.',
                            qualityComment: 'Pendiente de evaluación.',
                            lastEvaluation: null,
                            evaluator: currentSupervisor.username
                        }));

                        const asesorData = {
                            id: existingAsesorIndex >= 0 ? currentSupervisor.asesores[currentModule][existingAsesorIndex].id : generateId(),
                            username: username,
                            name: name,
                            password: existingAsesorIndex >= 0 ? currentSupervisor.asesores[currentModule][existingAsesorIndex].password : 'temp123',
                            module: currentModule,
                            email: values[2] || `${username}@cnci.com`,
                            phone: values[3] || '',
                            department: values[4] || 'General',
                            supervisor: currentSupervisor.username,
                            categories: categories,
                            badges: existingAsesorIndex >= 0 ? currentSupervisor.asesores[currentModule][existingAsesorIndex].badges : [],
                            performance: {
                                callsHandled: 0,
                                averageCallTime: '0:00',
                                customerSatisfaction: 0,
                                goalsAchieved: 0,
                                attendanceRate: 100
                            },
                            createdAt: existingAsesorIndex >= 0 ? currentSupervisor.asesores[currentModule][existingAsesorIndex].createdAt : new Date().toISOString().split('T')[0],
                            lastUpdate: new Date().toISOString()
                        };

                        if (existingAsesorIndex >= 0) {
                            // Update existing asesor
                            currentSupervisor.asesores[currentModule][existingAsesorIndex] = asesorData;
                            updatedCount++;
                        } else {
                            // Add new asesor
                            currentSupervisor.asesores[currentModule].push(asesorData);
                            importedCount++;
                        }

                        // Also create/update standalone user
                        systemData.users[username] = {
                            password: asesorData.password,
                            role: 'asesor',
                            name: name,
                            email: asesorData.email,
                            phone: asesorData.phone,
                            department: asesorData.department,
                            supervisor: currentSupervisor.username,
                            status: 'active',
                            createdAt: asesorData.createdAt,
                            lastLogin: null,
                            currentModule: currentModule,
                            moduleData: {
                                [currentModule]: {
                                    categories: categories,
                                    badges: asesorData.badges,
                                    performance: asesorData.performance
                                }
                            }
                        };

                        // Initialize other modules with empty data
                        Object.keys(systemData.config.modules).forEach(moduleId => {
                            if (moduleId !== currentModule) {
                                systemData.users[username].moduleData[moduleId] = {
                                    categories: [],
                                    badges: [],
                                    performance: {}
                                };
                            }
                        });

                    } catch (rowError) {
                        console.error(`Error processing row ${i}:`, rowError);
                        errorCount++;
                    }
                }

                // Update Firebase if connected
                if (isFirebaseConnected) {
                    try {
                        // Update supervisor data
                        await db.collection('users').doc(currentSupervisor.username).update({
                            asesores: currentSupervisor.asesores,
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Update standalone users
                        const batch = db.batch();
                        currentSupervisor.asesores[currentModule].forEach(asesor => {
                            const userRef = db.collection('users').doc(asesor.username);
                            batch.set(userRef, systemData.users[asesor.username], { merge: true });
                        });
                        await batch.commit();
                    } catch (error) {
                        console.error('Error updating Firebase:', error);
                    }
                }

                // Clear file input
                event.target.value = '';

                // Refresh table
                loadAsesoresTable();

                // Show results
                const message = `Importación completada: ${importedCount} nuevos asesores, ${updatedCount} actualizados`;
                if (errorCount > 0) {
                    showError(`${message}. ${errorCount} errores encontrados.`);
                } else {
                    showSuccess(message);
                }

            } catch (error) {
                console.error('Error importing CSV:', error);
                showError('Error al importar CSV: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Asesor details modal functions
        function openAsesorDetailsModal(asesorId) {
            editingAsesorId = asesorId;
            const asesor = currentSupervisor.asesores[currentModule].find(a => a.id === asesorId);
            
            if (!asesor) return;
            
            const content = document.getElementById('asesorDetailsContent');
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Información Personal</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nombre</label>
                                <input type="text" id="editAsesorName" value="${asesor.name}" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Usuario</label>
                                <input type="text" id="editAsesorUsername" value="${asesor.username}" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="editAsesorEmail" value="${asesor.email || ''}" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                                <input type="tel" id="editAsesorPhone" value="${asesor.phone || ''}" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:border-cnci-blue focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Evaluaciones</h4>
                        <div id="categoriesEditor" class="space-y-4">
                            ${asesor.categories.map((category, index) => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <h5 class="font-medium text-gray-800 mb-3">${category.name}</h5>
                                    <div class="space-y-2">
                                        ${category.criteria.map((criterion, critIndex) => `
                                            <div class="flex items-center space-x-2">
                                                <label class="text-sm text-gray-600 flex-1">${criterion.name}</label>
                                                <input type="number" min="0" max="10" step="0.1" 
                                                       value="${criterion.score}" 
                                                       data-category="${index}" 
                                                       data-criterion="${critIndex}"
                                                       class="criterion-score w-20 border border-gray-300 rounded px-2 py-1 text-sm focus:border-cnci-blue focus:outline-none">
                                            </div>
                                        `).join('')}
                                        <div class="mt-3">
                                            <label class="block text-sm font-medium text-gray-700">Comentario de Supervisión</label>
                                            <textarea data-category="${index}" data-field="supervisionComment" 
                                                      class="category-comment mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:border-cnci-blue focus:outline-none" 
                                                      rows="2">${category.supervisionComment || ''}</textarea>
                                        </div>
                                        <div class="mt-3">
                                            <label class="block text-sm font-medium text-gray-700">Comentario de Calidad</label>
                                            <textarea data-category="${index}" data-field="qualityComment" 
                                                      class="category-comment mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:border-cnci-blue focus:outline-none" 
                                                      rows="2">${category.qualityComment || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners for real-time score calculation
            content.querySelectorAll('.criterion-score').forEach(input => {
                input.addEventListener('input', updateCategoryScore);
            });
            
            document.getElementById('asesorDetailsModal').classList.remove('hidden');
        }

        function closeAsesorDetailsModal() {
            document.getElementById('asesorDetailsModal').classList.add('hidden');
            editingAsesorId = null;
        }

        // Update category score based on criteria
        function updateCategoryScore(event) {
            const input = event.target;
            const categoryIndex = parseInt(input.dataset.category);
            const criterionIndex = parseInt(input.dataset.criterion);
            
            const asesor = currentSupervisor.asesores[currentModule].find(a => a.id === editingAsesorId);
            if (!asesor) return;
            
            const category = asesor.categories[categoryIndex];
            const criterion = category.criteria[criterionIndex];
            
            // Update criterion score
            criterion.score = parseFloat(input.value) || 0;
            
            // Recalculate category score based on weighted criteria
            let weightedSum = 0;
            let totalWeight = 0;
            
            category.criteria.forEach(crit => {
                weightedSum += crit.score * crit.weight;
                totalWeight += crit.weight;
            });
            
            category.score = totalWeight > 0 ? weightedSum / totalWeight : 0;
        }

        // Save asesor details
        async function saveAsesorDetails() {
            const asesor = currentSupervisor.asesores[currentModule].find(a => a.id === editingAsesorId);
            if (!asesor) return;
            
            // Update basic info
            const newName = document.getElementById('editAsesorName').value.trim();
            const newUsername = document.getElementById('editAsesorUsername').value.trim();
            const newEmail = document.getElementById('editAsesorEmail').value.trim();
            const newPhone = document.getElementById('editAsesorPhone').value.trim();
            
            // Check if username changed and is unique
            if (newUsername !== asesor.username && systemData.users[newUsername]) {
                showError('El nombre de usuario ya existe');
                return;
            }
            
            const oldUsername = asesor.username;
            
            // Update asesor data
            asesor.name = newName;
            asesor.username = newUsername;
            asesor.email = newEmail;
            asesor.phone = newPhone;
            asesor.lastUpdate = new Date().toISOString();
            
            // Update category comments
            document.querySelectorAll('.category-comment').forEach(textarea => {
                const categoryIndex = parseInt(textarea.dataset.category);
                const field = textarea.dataset.field;
                asesor.categories[categoryIndex][field] = textarea.value;
            });
            
            // Update standalone user if username changed
            if (oldUsername !== newUsername) {
                systemData.users[newUsername] = systemData.users[oldUsername];
                delete systemData.users[oldUsername];
            }
            
            // Update standalone user data
            const standaloneUser = systemData.users[newUsername];
            if (standaloneUser) {
                standaloneUser.name = newName;
                standaloneUser.email = newEmail;
                standaloneUser.phone = newPhone;
                standaloneUser.lastUpdate = new Date().toISOString();
                
                // Update module data
                if (standaloneUser.moduleData && standaloneUser.moduleData[currentModule]) {
                    standaloneUser.moduleData[currentModule].categories = asesor.categories;
                }
            }
            
            // Update Firebase
            if (isFirebaseConnected) {
                try {
                    // Update supervisor data
                    await db.collection('users').doc(currentSupervisor.username).update({
                        asesores: currentSupervisor.asesores,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update standalone user
                    if (oldUsername !== newUsername) {
                        await db.collection('users').doc(newUsername).set(standaloneUser);
                        await db.collection('users').doc(oldUsername).delete();
                    } else {
                        await db.collection('users').doc(newUsername).update(standaloneUser);
                    }
                } catch (error) {
                    console.error('Error updating Firebase:', error);
                }
            }
            
            closeAsesorDetailsModal();
            loadAsesoresTable();
            showSuccess('Datos del asesor actualizados correctamente');
        }

        /**
         * Asesor Functions
         */
        
        // Load asesor view
        function loadAsesorView(userData) {
            elements.asesorView.classList.remove('hidden');
            
            document.getElementById('asesorName').textContent = userData.name;
            
            // Initialize module selector
            initializeModuleSelectors();
            
            // Set current module
            currentModule = userData.currentModule || 'M1';
            document.getElementById('moduleSelector').value = currentModule;
            
            // Load module data
            loadAsesorModuleData();
        }

        // Switch tabs in asesor view
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-cnci-blue', 'text-cnci-blue');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active', 'border-cnci-blue', 'text-cnci-blue');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
        }

        // Load categories for asesor view
        function loadCategories(categories) {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            
            if (!categories || categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">📊</div>
                        <p>No hay evaluaciones disponibles para este módulo</p>
                        <p class="text-sm">Contacta a tu supervisor para más información</p>
                    </div>
                `;
                return;
            }
            
            categories.forEach(category => {
                const categoryCard = createCategoryCard(category);
                container.appendChild(categoryCard);
            });
        }

        // Create category card
        function createCategoryCard(category) {
            const card = document.createElement('div');
            const colorClasses = {
                blue: 'from-blue-50 to-blue-100 border-blue-200',
                green: 'from-green-50 to-green-100 border-green-200',
                purple: 'from-purple-50 to-purple-100 border-purple-200',
                orange: 'from-orange-50 to-orange-100 border-orange-200',
                red: 'from-red-50 to-red-100 border-red-200'
            };
            
            const colorClass = colorClasses[category.color] || colorClasses.blue;
            
            card.className = `bg-gradient-to-r ${colorClass} border rounded-lg p-6`;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">${category.name}</h4>
                    <span class="text-2xl font-bold text-gray-700">${category.score.toFixed(1)}</span>
                </div>
                
                <div class="space-y-3 mb-4">
                    ${category.criteria.map(criterion => `
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-700">${criterion.name}</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-800">${criterion.score.toFixed(1)}</span>
                                <div class="w-16 bg-gray-200 rounded-full h-2">
                                    <div class="bg-${category.color}-600 h-2 rounded-full transition-all duration-300" 
                                         style="width: ${(criterion.score / 10) * 100}%"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${category.supervisionComment ? `
                    <div class="bg-white bg-opacity-50 rounded-lg p-3 mb-3">
                        <h5 class="text-sm font-medium text-gray-700 mb-1">Comentario de Supervisión:</h5>
                        <p class="text-sm text-gray-600">${category.supervisionComment}</p>
                    </div>
                ` : ''}
                
                ${category.qualityComment ? `
                    <div class="bg-white bg-opacity-50 rounded-lg p-3">
                        <h5 class="text-sm font-medium text-gray-700 mb-1">Comentario de Calidad:</h5>
                        <p class="text-sm text-gray-600">${category.qualityComment}</p>
                    </div>
                ` : ''}
                
                ${category.lastEvaluation ? `
                    <div class="mt-3 text-xs text-gray-500">
                        Última evaluación: ${new Date(category.lastEvaluation).toLocaleDateString()}
                    </div>
                ` : ''}
            `;
            
            return card;
        }

        // Load badges for asesor view
        function loadBadges(badges) {
            const container = document.getElementById('earnedBadges');
            container.innerHTML = '';
            
            if (!badges || badges.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">🏆</div>
                        <p>Aún no has obtenido insignias</p>
                        <p class="text-sm">¡Sigue trabajando para ganar reconocimientos!</p>
                    </div>
                `;
                return;
            }
            
            badges.forEach(badge => {
                const badgeCard = createBadgeCard(badge);
                container.appendChild(badgeCard);
            });
        }

        // Create badge card
        function createBadgeCard(badge) {
            const card = document.createElement('div');
            card.className = 'bg-gradient-to-r from-yellow-50 to-yellow-100 border border-yellow-200 rounded-lg p-4 text-center';
            card.innerHTML = `
                <div class="text-4xl mb-2">${badge.emoji}</div>
                <h4 class="font-semibold text-gray-800 mb-1">${badge.title}</h4>
                <p class="text-sm text-gray-600 mb-2">${badge.description}</p>
                ${badge.dateEarned ? `
                    <div class="text-xs text-gray-500">
                        Obtenida: ${new Date(badge.dateEarned).toLocaleDateString()}
                    </div>
                ` : ''}
                ${badge.criteria ? `
                    <div class="text-xs text-gray-500 mt-1">
                        ${badge.criteria}
                    </div>
                ` : ''}
            `;
            return card;
        }

        /**
         * Initialization
         */
        
        // Initialize application
        async function initializeApp() {
            console.log('🚀 Initializing CNCI Evaluation System...');
            
            // Add a small delay to ensure all scripts are loaded
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Verify systemData is properly loaded
            console.log('📊 System data loaded:', !!systemData);
            console.log('📊 System data structure:', {
                hasConfig: !!systemData.config,
                hasUsers: !!systemData.users,
                userCount: systemData.users ? Object.keys(systemData.users).length : 0
            });
            
            // Force re-initialize systemData if it's corrupted
            if (!systemData || !systemData.users || Object.keys(systemData.users).length === 0) {
                console.warn('⚠️ SystemData corrupted, reinitializing...');
                
                // Reinitialize with fresh data
                window.systemData = {
                    config: {
                        loginTitle: "Sistema de Evaluación CNCI",
                        loginSubtitle: "Ingresa tus credenciales para continuar",
                        version: "5.0",
                        lastUpdate: new Date().toISOString(),
                        modules: MODULES
                    },
                    users: {
                        'admin': {
                            password: 'admin123',
                            role: 'super_admin',
                            name: 'Administrador Principal',
                            status: 'active',
                            createdAt: '2024-01-01',
                            permissions: ['all']
                        },
                        'supervisor1': {
                            password: 'super123',
                            role: 'supervisor',
                            name: 'Juan Supervisor',
                            email: 'supervisor@cnci.com',
                            status: 'active',
                            createdAt: '2024-01-10',
                            lastLogin: null,
                            permissions: ['manage_asesores', 'edit_titles', 'export_data'],
                            asesores: {}
                        },
                        'maria.garcia': {
                            password: 'asesor123',
                            role: 'asesor',
                            name: 'María García',
                            email: 'maria.garcia@cnci.com',
                            phone: '+52 55 1234 5678',
                            department: 'Atención al Cliente',
                            supervisor: 'supervisor1',
                            status: 'active',
                            createdAt: '2024-01-15',
                            lastLogin: null,
                            currentModule: 'M1',
                            moduleData: {
                                'M1': {
                                    categories: [],
                                    badges: [],
                                    performance: {}
                                }
                            }
                        }
                    }
                };
                
                // Update global reference
                systemData = window.systemData;
                
                console.log('✅ SystemData reinitialized successfully');
            }
            
            console.log('👥 Total users in system:', Object.keys(systemData.users).length);
            console.log('🔑 Available credentials:');
            
            // Log available users for debugging
            Object.entries(systemData.users).forEach(([username, userData]) => {
                console.log(`   ✅ ${username}: ${userData.password} (${userData.role})`);
            });
            
            // Wait a bit for DOM to be fully ready
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Initialize DOM elements with error checking
            elements = {
                loginForm: document.getElementById('loginForm'),
                errorMessage: document.getElementById('errorMessage'),
                errorText: document.getElementById('errorText'),
                loadingSpinner: document.getElementById('loadingSpinner'),
                loginButton: document.getElementById('loginButton'),
                
                // Views
                loginView: document.querySelector('body > div:first-child'),
                superAdminView: document.getElementById('superAdminView'),
                supervisorView: document.getElementById('supervisorView'),
                asesorView: document.getElementById('asesorView'),
                
                // Tables
                usersTableBody: document.getElementById('usersTableBody'),
                asesoresTableBody: document.getElementById('asesoresTableBody'),

                // Firebase status elements
                adminFirebaseStatus: document.getElementById('adminFirebaseStatus'),
                adminStatusIcon: document.getElementById('adminStatusIcon'),
                adminStatusText: document.getElementById('adminStatusText'),
                supervisorFirebaseStatus: document.getElementById('supervisorFirebaseStatus'),
                supervisorStatusIcon: document.getElementById('supervisorStatusIcon'),
                supervisorStatusText: document.getElementById('supervisorStatusText')
            };
            
            console.log('Elements found:', {
                loginForm: !!elements.loginForm,
                errorMessage: !!elements.errorMessage,
                errorText: !!elements.errorText,
                loadingSpinner: !!elements.loadingSpinner,
                loginButton: !!elements.loginButton,
                superAdminView: !!elements.superAdminView,
                supervisorView: !!elements.supervisorView,
                asesorView: !!elements.asesorView
            });
            
            // Ensure all critical elements exist
            if (!elements.loginForm) {
                console.error('Critical error: Login form not found!');
                return;
            }
            
            if (!elements.errorMessage || !elements.errorText) {
                console.error('Critical error: Error message elements not found!');
                return;
            }
            
            // Set up login form handler
            elements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const usernameInput = document.getElementById('usuario');
                const passwordInput = document.getElementById('password');
                
                if (!usernameInput || !passwordInput) {
                    console.error('Username or password input not found!');
                    return;
                }
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                
                console.log('=== LOGIN ATTEMPT ===');
                console.log('Username:', username);
                console.log('Password length:', password.length);
                console.log('Available users:', Object.keys(systemData.users));
                
                if (!username || !password) {
                    showError('Por favor, completa todos los campos');
                    return;
                }
                
                showLoading(true);
                
                try {
                    console.log('Calling authenticateUser...');
                    const userData = authenticateUser(username, password);
                    currentUser = userData;
                    
                    console.log('✅ Authentication successful!');
                    console.log('User data:', userData);
                    
                    // Store session
                    sessionStorage.setItem('currentUser', JSON.stringify(userData));
                    
                    // Update user data in Firebase if connected
                    if (isFirebaseConnected && username !== 'admin') {
                        try {
                            await db.collection('users').doc(username).update({
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } catch (error) {
                            console.error('Error updating last login:', error);
                        }
                    }
                    
                    // Route to appropriate view
                    console.log('Hiding all views...');
                    hideAllViews();
                    
                    console.log('Routing to view for role:', userData.role);
                    
                    switch (userData.role) {
                        case 'super_admin':
                            console.log('Loading super admin view...');
                            loadSuperAdminView();
                            break;
                        case 'supervisor':
                            console.log('Loading supervisor view...');
                            loadSupervisorView(userData);
                            break;
                        case 'asesor':
                            console.log('Loading asesor view...');
                            loadAsesorView(userData);
                            break;
                        default:
                            console.error('Unknown role:', userData.role);
                            showError('Rol de usuario no reconocido: ' + userData.role);
                            return;
                    }
                    
                } catch (error) {
                    console.error('❌ Login error:', error);
                    showError(error.message);
                } finally {
                    showLoading(false);
                }
            });
            
            console.log('✅ Login form handler attached successfully');
            
            // Check for existing session
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    // Verify user still exists and is active
                    const userData = systemData.users[currentUser.username];
                    if (userData && (userData.status === 'active' || userData.role === 'super_admin')) {
                        hideAllViews();
                        
                        switch (currentUser.role) {
                            case 'super_admin':
                                loadSuperAdminView();
                                break;
                            case 'supervisor':
                                loadSupervisorView(currentUser);
                                break;
                            case 'asesor':
                                loadAsesorView(currentUser);
                                break;
                        }
                        
                        console.log('Session restored for:', currentUser.username);
                    } else {
                        // Invalid session, clear it
                        sessionStorage.removeItem('currentUser');
                        currentUser = null;
                    }
                } catch (error) {
                    console.error('Error restoring session:', error);
                    sessionStorage.removeItem('currentUser');
                    currentUser = null;
                }
            }
            
            // Initialize Firebase connection
            await initializeFirebase();
            
            console.log('✅ Application initialized successfully');
            console.log('📋 Available credentials:');
            console.log('🔑 Super Admin: admin / admin123');
            console.log('🔑 Supervisor: supervisor1 / super123');
            console.log('🔑 Asesor: maria.garcia / asesor123');
        }



        // Start application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a14f4d412814af',t:'MTc1NzAyODk5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
